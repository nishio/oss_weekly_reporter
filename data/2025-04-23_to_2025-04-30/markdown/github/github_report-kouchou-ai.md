# GitHub レポート: digitaldemocracy2030/kouchou-ai

期間: 2025-04-23T23:24:08.222346+09:00 から 2025-04-30T23:24:08.222346+09:00 まで

## Issues

### 過去7日間に完了されたissue (14件)

### [[DOCUMENT]クラスタ → グループ への言い換え](https://github.com/digitaldemocracy2030/kouchou-ai/issues/401)

**作成者:** masatosasano2  
**作成日:** 2025-04-30T07:33:54Z  
**内容:**

# 現在の問題点
READMEや管理画面の設定において「クラスタ」「クラスタリング」などの用語が使われているが、伝わらない可能性がある。

# 提案内容
「グループ」「グルーピング」などと言い換える。
補足：[宇多津町の報告資料](https://www.town.utazu.lg.jp/uploaded/attachment/3122.pdf)ではそのように言い換えられていた。

**コメント:** なし

---

### [[REFACTOR] 「クラスタ」と「意見グループ」という表現が混在している](https://github.com/digitaldemocracy2030/kouchou-ai/issues/388)

**作成者:** nasuka  
**作成日:** 2025-04-29T06:59:44Z  
**内容:**

# 現在の問題点
* 元々はクラスタという表現が使われていたが、この名称は多くのユーザーにとってわかりにくいので、「意見グループ」という名称にする方針になった
* 一方で、以前の名称が残ってしまっている部分がある

# 提案内容
* 「クラスタ」という名称が使われている部分を「意見グループ」に変更する
  * server（api）まで回収する場合、影響範囲が大きくなるので、一旦ユーザーの目に触れるclient/client-admin内で名称を変更する
  * 変数名・クラス名は一旦そのままで、目に触れる文言の部分を修正する


**コメント:** なし

---

### [[BUG]レポート作成時に編集したプロンプトが反映されない](https://github.com/digitaldemocracy2030/kouchou-ai/issues/375)

**作成者:** nasuka  
**作成日:** 2025-04-25T08:19:02Z  
**内容:**

### 概要
* レポート作成時にプロンプトを編集しても、その内容が反映されるデフォルトのプロンプトでレポートが作成される
  * 少なくともextractionについてはこの事象を確認済み

### 再現手順

1. レポート作成時にプロンプトを編集する
2. レポート作成を実行する
3. apiサーバーに保存されているconfigファイルを確認すると、デフォルトプロンプトが利用されていることが確認できる

### 期待する動作
編集したプロンプトが反映される


### その他
以前はこういった声は聞かなかったので、恐らく直近のリファクタが原因の可能性がありそう

**コメント:** なし

---

### [[FEATURE] LLM用のプロンプトに出力されるjsonフォーマットを入力できるようにする](https://github.com/digitaldemocracy2030/kouchou-ai/issues/373)

**作成者:** tokoroten  
**作成日:** 2025-04-25T06:31:12Z  
**内容:**

# 背景
#352 で、プロンプトに出力フォーマットを指示することで、出力フォーマットを固定しようとしている。

現状、response_format には、jsonを返せという指定しか入っていません。

https://github.com/digitaldemocracy2030/kouchou-ai/blob/d49132c34db0dec6cf08f12fa3fe6f1da990647a/server/broadlistening/pipeline/services/llm.py#L43

プロンプトでレスポンスフォーマットを固定するように頑張るのではなく、プロンプトとともにレスポンスフォーマットを入力できるようにして、それをAPIから食わせられるようにした方がいいです。

structured outputsのオプションを指定することで、帰ってくるフォーマットを明示することができます。

https://platform.openai.com/docs/guides/structured-outputs
https://gigazine.net/news/20240807-openai-structured-outputs/

# 提案内容
is_json フラグだけでなく、出力のjson_formatを入力できるように、インターフェースを拡張する


**コメント:** なし

---

### [[BUG] プロンプトのAIバイアス問題の修正](https://github.com/digitaldemocracy2030/kouchou-ai/issues/371)

**作成者:** devin-ai-integration[bot]  
**作成日:** 2025-04-25T06:18:36Z  
**内容:**

# プロンプトのAIバイアス問題の修正

## 問題の説明
現在のプロンプト設定では、分析結果に「AI技術の導入」という文言が不適切に含まれる問題が発生しています。これはプロンプト内の例示がAI関連の内容に偏っているためです。

## 原因
以下の2つのファイルに問題があります：

1. `client-admin/app/create/mergeLabellingPrompt.ts`
   - 出力例に「AI技術の導入による意見分析の効率化への期待」という文言が含まれている
   - これがAIモデルの出力に影響を与え、AI関連の文言が不適切に含まれる原因となっている

2. `client-admin/app/create/extractionPrompt.ts`
   - 「人工知能に関する公開協議を実施した状況を想定しています」という文言がある
   - これにより、入力データがAIに関するものであるという前提が作られている

## 修正方針
1. プロンプト内の例示をより一般的なトピックに変更する
2. 特定のドメイン（AI技術など）に依存しない例を使用する
3. 入力データの内容に依存せず、汎用的に機能するプロンプトに修正する

## 期待される結果
- 分析結果に「AI技術の導入」などの不適切な文言が含まれなくなる
- 様々なトピックの入力データに対して、適切な分析結果が得られるようになる


**コメント:** なし

---

### [(実験)embeddingベースの前処理](https://github.com/digitaldemocracy2030/kouchou-ai/issues/361)

**作成者:** nishio  
**作成日:** 2025-04-23T02:46:22Z  
**内容:**

>20万件となるとまともに閲覧するのが難しくなる可能性が高いので、少なくとも処理負荷を軽減するための施策（上述されていたように似たものをまとめた上で一つの意見とする・何らかのロジックでフィルタする等）は必要になりそうです。

>鶏と卵の関係である程度具体的にならないとどう統合するかも見えないから
1: 独立したスクリプトとして機能するものが作れるが実験
2: それをapiサーバに統合するか検討
3: それをどんなGUIでユーザに見せるか検討
という流れがスムーズかなと思いました

>1に関してはextractionしないでembeddingして階層クラスタリング、適当な閾値ごとに「くっつく最も離れたサンプル」を表示して「これとこれをくっつけていいなら何件に減ります」とやるイメージが湧きました

**コメント:** なし

---

### [[FEATURE]CSVアップロード時にデフォルトでクラスタ数が設定されてほしい](https://github.com/digitaldemocracy2030/kouchou-ai/issues/303)

**作成者:** masatosasano2  
**作成日:** 2025-04-13T06:58:07Z  
**内容:**

# 背景
クラスタ数の設定の一手間を減らしたい

# 提案内容
- クラスタ数について「この設定にする」を押さないと推奨設定通りにならず、そのことが詳細画面を開かないとわかりにくい
- クラスタ数のデフォルト値より小さい件数のCSVを取り込んだ時、先に進もうとするとアラートが出てくれるのは嬉しいが、それなら最初から推奨設定をセットして欲しい


**コメント:** なし

---

### [[FEATURE]LLM出力形式の揺らぎによる抽出エラー](https://github.com/digitaldemocracy2030/kouchou-ai/issues/296)

**作成者:** nishio  
**作成日:** 2025-04-13T01:22:24Z  
**内容:**

# 背景
LLMからの応答が、プロンプトで期待したJSON形式（例: 文字列リスト [str]）と異なる形式（例: オブジェクトリスト [{“意見”:str, “トピック”:str}]）で返ってくることがあり、データ抽出が失敗したり、抽出される意見数が少なくなったりする。

「Rate limitかと思われた抽出データが少ない事例の一つにおいて、JSON List[str]ではなく[{“意見”:str, “トピック”:str}]が返っていたせい(nishio)」
「これのせいで抽出されるデータが減るのは困るし、それに多分ユーザは気づけなくて「こんなもんか〜」となりそう」

# 解決策

プロンプトを改善し、出力形式の指示をより明確かつ堅牢にする。

LLMからの応答をパースする際に、期待する形式以外もある程度許容する、またはエラーハンドリングを強化して異常を検知できるようにする。

**コメント:** なし

---

### [[DOCUMENT].envファイルの不可視問題 (Mac Finder)](https://github.com/digitaldemocracy2030/kouchou-ai/issues/291)

**作成者:** nishio  
**作成日:** 2025-04-13T00:51:49Z  
**内容:**

# 現在の問題点
MacのFinderでは .env ファイルがデフォルトで非表示のため、cp example.env .env を実行した後、ファイルを見つけられないユーザーがいる。

「.env見つからない」
「Sampleからコピーしてきたとき、それをVScodeで開こうとするときに見つからない」
「隠しファイルをfinderで開こうとしていた」


# 提案内容

READMEで、FinderではなくVSCodeなどのエディタでプロジェクトフォルダを開いて .env ファイルを編集することを推奨する。「実はFinder経由でどうこうするよりVSCodeでフォルダを開いてしまうほうが良かった」


**コメント:** なし

---

### [[FEATURE]zipでのリリース](https://github.com/digitaldemocracy2030/kouchou-ai/issues/288)

**作成者:** nishio  
**作成日:** 2025-04-13T00:14:59Z  
**内容:**

# 背景
Docker/Gitのインストール障壁 (特に自治体ユーザー)
セキュリティポリシーやITスキル不足により、DockerやGitのインストール自体が大きなハードルとなっている。
「リポジトリ」などのIT専門用語が、非エンジニアのユーザーにとって理解しにくい。

>「自治体関係者の中でのアーリーアダプターたちが試す際に、最初の①リポジトリをクローン」段階で既にかなり大きなハードルになっている。」
「Dockerのインストール、Gitのインストールという部分で既にわけがわからなくなっている。」
>「リポジトリ」概念を避けて行政に納品する際は、zip圧縮などをしたりします。
> 「非エンジニアユーザー向けに、GitをインストールせずにZIPダウンロードで運用のほうがよい？(たねのぶ)」

# 解決策

zipでリリースすればgit cloneの部分の解説は必要なくなる


**コメント:** なし

---

### [（アルゴリズム検証） 広聴AIで出力したクラスタのタイトルが抽象的になる問題の解決](https://github.com/digitaldemocracy2030/kouchou-ai/issues/269)

**作成者:** nasuka  
**作成日:** 2025-04-09T06:22:31Z  
**内容:**

# 背景
広聴AIで出力した第一階層のクラスタタイトルが、TTTCのタイトルと比べて具体性に欠けるという声がある。
 
衆院選のデータセットでクラスタタイトルを出力した例を以下に記載する。クラスタ数はどちらも15で設定している。
本来はクラスタに属するデータ点との整合性なども含めて議論するのが理想だが、こちらではクラスタの抽象度についてのみ議論する。

### TTTCの出力結果
レポートのURL: https://news.ntv.co.jp/static/shugiinsenkyo2024/closed-1027/index.html

選挙結果への関心と不安
立憲民主党の支持増加と自民党への批判
過半数割れの可能性と連立政権の模索
投票率と市民参加の重要性
候補者の当選とその影響
選挙特番のエンタメ化
国民民主党と立憲民主党の議席増加への注目
議員の落選に対する反応
石破氏の責任問題
政権交代の可能性
地域別支持動向
和歌山2区の選挙結果
選挙結果の誤報や虚偽情報への懸念
れいわ新選組の躍進と支持拡大への関心
出口調査結果への関心と懐疑


### 広聴AIの出力結果

選挙結果と政治倫理に対する多様な反応と期待
地域別選挙動向と多様な反応
選挙に対する多様な関心と報道の影響
選挙参加と投票率に関する多様な視点と期待
選挙における政党の躍進と略称問題に対する多様な反応
衆院選結果に対する多様な反応と政治的期待
選挙における政党批判と有権者の多様な視点
選挙報道とスポーツ中継の視聴体験とメディアの役割
選挙結果の信頼性と世襲政治に対する多様な反応
日本の政治再編と選挙結果の影響
石破政権の持続性と自民党の未来に対する懸念と期待
日本の政治情勢における政党支持の変動とその影響
衆院選後の政治的再編と連立政権の行方
れいわ新選組の議席増加に対する多様な反応と期待
選挙における政権交代と地域政党の影響に関する多様な視点


感覚的だが、TTTCの出力結果が具体的な行動・現象や固有名詞（個人名・政党名等）がクラスタ名に含まれる傾向がある一方で、広聴AIの方は抽象性の高いタイトルがついているケースが多い。
一概にどちらが悪いといえるものはないが、実用性を考えるとTTTC程度の抽象度で記載されている方が有用な場合がある。

なお、o3-miniでも評価したが、同様の評価が記載されている。
https://chatgpt.com/share/67f60d38-43b4-800f-a20f-3836dbfa4518

![Image](https://github.com/user-attachments/assets/00a6bc92-5a48-4237-8da8-72be1dfbc1e5)

このような差分が生まれる要因として、以下が想定される。

* クラスタリングアルゴリズムの違い
  * 広聴AIではk-meansで第二階層のクラスタを形成した後にクラスタをマージして第一階層を形成するが、TTTCではspectral clusteringでクラスタを形成する
* クラスタリング時に用いる埋め込みの次元の違い
    * 広聴AIではUMAP後の2次元でクラスタリングを行っているが、TTTCでは元のembeddingでクラスタリングを行っている
      * 二次元空間上で飛び地ができるのを防ぐために広聴AIではこのような実装となっている
* プロンプトの違い
  * （アルゴリズムの違いに依存する話だが）広聴AIでは、第二階層のクラスタのタイトル・説明と、サンプリングしたクラスタに属するデータのテキストの情報に基づいて第一階層のタイトル・説明を生成している。一方でTTTCでは、下層のクラスタタイトル・説明を用いていない。
    * 下層のクラスタのタイトル・説明を包含するように指示しているため、抽象的なタイトルが生成されている可能性がある。


# 提案内容
プロンプトレベルでの修正と、アルゴリズムレベルでの修正がある。

## プロンプトレベルでの修正
1. デフォルトプロンプトの文言のチューニング・修正
2. プロンプトに入力する情報の修正
    例. 下層のタイトル・説明は含めずに、純粋にデータ点の情報だけ入力して第一階層のタイトル・説明を生成する


## アルゴリズムレベルでの修正
1. 元の埋込を用いてクラスタリングする
2. k-means以外のアルゴリズム（spectral clustering, hdbscan）を採用する


**コメント:** なし

---

### [[FEATURE] frontからstaticなHTMLファイルをexportしてDownloadできるようにする](https://github.com/digitaldemocracy2030/kouchou-ai/issues/220)

**作成者:** takahiroanno  
**作成日:** 2025-04-02T11:43:27Z  
**内容:**

# 背景
* static exportが実装されたが、現在はCLIで実行することしかできず、Webアプリ上で実行できない
  * `make client-build-static` を実行するとCLIではstatic exportができる
  * 参考
    * https://github.com/digitaldemocracy2030/kouchou-ai/pull/198
    * https://github.com/digitaldemocracy2030/kouchou-ai/pull/195


# 提案内容
* adminの一覧画面で、static exportを実行できるようにする

**コメント:** なし

---

### [[FEATURE]レポート一覧のクリック可能範囲を広げる](https://github.com/digitaldemocracy2030/kouchou-ai/issues/207)

**作成者:** nishio  
**作成日:** 2025-03-31T10:28:45Z  
**内容:**

# 背景

<img width="1023" alt="Image" src="https://github.com/user-attachments/assets/01686efb-d5a0-4679-b456-435ca5e978d2" />

レポートを見るためにクリックするところか説明のない灰色の領域だけ
目の前で使ってもらったらどこをクリックしたらいいか戸惑っていた

# 提案内容
<!-- 実装案やデザイン案があれば記入してください -->

ブロック全体に広げた方がいいのではと思った

**コメント:** なし

---

### [[REFACTOR] langchainの依存を削除する](https://github.com/digitaldemocracy2030/kouchou-ai/issues/58)

**作成者:** nasuka  
**作成日:** 2025-03-16T04:54:26Z  
**内容:**

# 現在の問題点
* 元のtalk to the cityがlangchainに依存していた関係で、kouchou aiでもlangchainを使用してLLM/embedding周りの処理を行っている
* 実装内容としては公式のSDKでも十分処理できるので、不要な依存を外したい

# 提案内容
langchainではなく、openaiの公式SDKを利用する


**コメント:** なし

---

### 過去7日間に作成されたissue (17件)

### [[REFACTOR] metadata のオプショナル化](https://github.com/digitaldemocracy2030/kouchou-ai/issues/403)

**作成者:** nanocloudx  
**作成日:** 2025-04-30T11:36:30Z  
**内容:**

# 現在の問題点
レポート作成者について記述する metadata というファイルを用意している
デフォルトとして「テスト環境」という画像を用意しているが、これがそのまま使われてしまっているかもしれない

# 提案内容
値や画像がなければ表示から消してしまい、metadata が指定された場合のみレポート作成者欄を用意してみると良いかもしれない

**コメント:** なし

---

### [[FEATURE] OpenRouterを使えるようにする](https://github.com/digitaldemocracy2030/kouchou-ai/issues/402)

**作成者:** nasuka  
**作成日:** 2025-04-30T08:55:15Z  
**内容:**

# 背景
* OpenAIが使えないユースケースがある
  * 政治的なキャンペーンでの利用ができない
    * 参考: https://github.com/digitaldemocracy2030/kouchou-ai/issues/255 
  * このため、用途によっては政党が利用できないケースがある
* そもそもOpenAIのみに依存している状況は好ましくないため、使えるLLMの選択肢は増やしたい
* また、OpenAI だと Rate Limit が厳しいという問題もある
  * https://github.com/digitaldemocracy2030/kouchou-ai/issues/295


# 提案内容
* OpenRouterを導入する

# 実装方針案
api
* 環境変数にOpenRouterのAPI Keyをセットできるようにする
* OpenRouterでAPIリクエストを投げられるようにする
  * すべてのモデルをサポートすると厳しそうなので、一旦以下をサポートできると良さそう
    * OpenAI（gpt-4o, 4o-mini）
      * 4.1系列もサポートしても良いかも？
    * Gemini（gemini2.5系列） 
  * 上記のモデルはstructured outputもサポートされているので実装が容易

client-admin
* 環境変数がセットされている場合にOpenRouterのモデルを選択肢に表示する 
  * あわせて、OpenAIのAPIキーがセットされている場合のみ、OpenAIのモデルを選択肢に表示するようにした方が良いかも（今はAPIキーがセットされていなくてもデフォルトで3つの選択肢が表示されている）
    * OpenAI APIキーで使うOpenAIのモデルとOpenRouterで使うOpenAIのモデルは区別できるようにしておいた方が良さそう（リクエストをapiに投げるときにどちらで投げるか判別できるようにするため）
      * e.g. `OpenAI gpt-4o` , `OpenRouter gpt-4o` のような表記にする？
* レポート作成時に選択されたモデルでapiにリクエストを送る
![Image](https://github.com/user-attachments/assets/dda0a3c7-ca57-4709-9c69-933f6eec3628)




**コメント:** なし

---

### [[FEATURE] 環境確認機能を作る](https://github.com/digitaldemocracy2030/kouchou-ai/issues/400)

**作成者:** tokoroten  
**作成日:** 2025-04-30T05:13:14Z  
**内容:**

# 背景
OpenAIのAPIKeyが正しくセットされているのかどうかが、実際にレポートの作成を始めるまで分からない


# 提案内容
管理画面、クライアント画面に以下の機能を付けたい

管理画面
- APIサーバが生きているかどうか
- OpenAIのkeyが正しいか、疎通できるかどうか（Azureも）
- クライアント用のフロントサーバが立っているかどうか
- ローカルLLM用のLM Studioが生きているかどうか



**コメント:** なし

---

### [Devin とのうまい協働方法を考える](https://github.com/digitaldemocracy2030/kouchou-ai/issues/398)

**作成者:** shingo-ohki  
**作成日:** 2025-04-30T03:14:27Z  
**内容:**

（広聴AIに限った話ではないですが、一旦ここに）
# 現在の問題点
Devin が活用され始めたが、それによる弊害があるのではないか？
あるとすれば、それを軽減し、人間と Devin のうまい協働方法はないか？

あくまで仮説です

> Shingo OHKI
  今日 11:10
Devin が大活躍してくれるのは嬉しい反面、なんとなく人間がPRを出しにくくなりそうな気がするのですが、これは気のせいですかね。
>Shingo OHKI
  [29分前](https://w1740803485-clv347541.slack.com/archives/C08FL58M3D3/p1745980862512019?thread_ts=1745979009.909629&cid=C08FL58M3D3)
ChatGPT が少し言語化を手伝ってくれました（最初の回答の解決策にはピンと来ていませんが）
https://chatgpt.com/share/68118c77-ca60-800c-9998-987c5fe25f37
「AI導入による文化の摩擦」が起きている自然な状態です。
なるほど、成長痛なんですかね。
気にならない人も多いと思いますし、決して Devin 活用にブレーキを踏みたい訳ではないです（どちらかというと人間が気持ちよく Devin と協働できるうまい活用方法を探したい） （編集済み） 
>ChatGPTChatGPT
[ChatGPT - Devin 活用と参加感](https://chatgpt.com/share/68118c77-ca60-800c-9998-987c5fe25f37)
Shared via ChatGPT (9 kB)
https://chatgpt.com/share/68118c77-ca60-800c-9998-987c5fe25f37
>Shingo OHKI
>3. 「Devinタスクを投げる場所」を整備
[#devin部屋](https://w1740803485-clv347541.slack.com/archives/C08PRQVQWSE) を作ったのは正しそう
>NISHIO Hirokazu
>11:51
>2030年のデジタル民主主義を考える上で、そもそも2030年にはOSS開発の形がだいぶ変わってそう
誰もAIエージェントと一緒にOSS活動をしていくことの知見をもってないので、この場が世界最先端の実験場の一つとして日々いろいろな観測と考察が生まれていくのだと思う

<!-- 現在のコードの何が問題なのか、どのような技術的負債があるかを説明してください -->

# 提案内容
<!-- どのようなリファクタリングを提案するのか、具体的に説明してください -->


**コメント:** なし

---

### [管理画面の基本e2eテスト計画](https://github.com/digitaldemocracy2030/kouchou-ai/issues/396)

**作成者:** devin-ai-integration[bot]  
**作成日:** 2025-04-30T01:43:59Z  
**内容:**

# 管理画面の基本e2eテスト計画

## テストの目的

このテストの目的は、ユーザーが管理画面にアクセスし、CSVファイルをアップロードして新しいレポートを作成するという基本的なワークフローが正常に機能することを確認することです。

## テストの前提条件

1. 管理画面にアクセスするための認証情報が設定されていること
2. テスト用のサンプルCSVファイルが用意されていること
3. APIレスポンスをモックするための設定が完了していること

## テストのステップ

### 1. 管理画面へのアクセスとログイン

- Basic認証を使用して管理画面にアクセス
- 管理画面のトップページが正しく表示されることを確認

### 2. レポート作成ページへの移動

- 「新しいレポートを作成する」ボタンをクリックしてレポート作成ページに移動
- ページタイトル「新しいレポートを作成する」が表示されることを確認

### 3. 基本情報の入力

- レポートIDフィールドに一意のIDを入力（例：`test-report-{timestamp}`）
- 質問フィールドにテスト用の質問を入力（例：「これはテスト質問です」）
- イントロダクションフィールドにテスト用の説明を入力（例：「これはテスト説明です」）

### 4. CSVファイルのアップロード

- CSVファイルタブが選択されていることを確認
- テスト用のサンプルCSVファイルをアップロード
- ファイルが正常にアップロードされ、ファイル名が表示されることを確認
- コメント列が自動的に選択されていることを確認（「comment」列がある場合）

### 5. レポート作成の実行

- 「レポート作成を開始」ボタンをクリックしてフォームを送信
- APIリクエストが正しいパラメータで送信されることを確認（モックAPIを使用）
- 成功メッセージが表示されることを確認
- ダッシュボードページにリダイレクトされることを確認

## モックの設定

テストでは以下のAPIエンドポイントをモックします：

1. レポート作成API（`/admin/reports`）
   - 成功レスポンス：`{ success: true, slug: 'test-report' }`

## テストコードの構造

テストコードは以下の構造で実装します：

```typescript
import { test } from '@playwright/test';
import { CreateReportPage } from '../../pages/admin/create-report';
import { setupBasicAuth } from '../../utils/auth';
import { mockReportCreation } from '../../utils/mock-api';

test.describe('レポート作成ページ', () => {
  test('CSVファイルをアップロードしてレポートを作成する', async ({ page }) => {
    // 認証設定
    await setupBasicAuth(page);
    
    // APIモック設定
    await mockReportCreation(page);
    
    // ページオブジェクトの初期化
    const createReportPage = new CreateReportPage(page);
    
    // レポート作成ページにアクセス
    await createReportPage.goto();
    
    // 基本情報の入力
    await createReportPage.fillBasicInfo(
      'test-report-' + Date.now(),
      'これはテスト質問です',
      'これはテスト説明です'
    );
    
    // CSVファイルのアップロード
    await createReportPage.uploadCsvFile('../../fixtures/sample.csv');
    
    // フォームの送信
    await createReportPage.submitForm();
    
    // リダイレクト先の確認
    await page.waitForURL('**/');
  });
});
```

## 実装上の注意点

1. テストの安定性を確保するため、固定のタイムアウト値ではなく、要素の表示を待つ方法を使用する
2. モックAPIレスポンスは実際のAPIレスポンスと同じ構造にする
3. テスト間の独立性を確保し、テスト順序に依存しないようにする
4. 既存のページオブジェクトとユーティリティを活用して効率的なテストを実装する

## 関連Issue

- #395 管理画面のe2eテスト拡張ケース（APIキーエラーやクレジット不足などのエラーケース）


**コメント:** なし

---

### [管理画面のe2eテスト拡張ケース](https://github.com/digitaldemocracy2030/kouchou-ai/issues/395)

**作成者:** devin-ai-integration[bot]  
**作成日:** 2025-04-30T01:41:40Z  
**内容:**

# 管理画面のe2eテスト拡張ケース

## 追加テストケース

1. Googleスプレッドシートからのデータインポート
   - スプレッドシートURLの入力と取得テスト
   - データ列の選択と表示確認

2. 入力バリデーションのテスト
   - 必須フィールドが空の場合のエラー表示
   - 無効なレポートIDの検証
   - 文字数制限の検証

3. AI詳細設定の変更とその反映
   - モデル選択の変更
   - ワーカー数の調整
   - PubComモードの切り替え
   - プロンプト設定の変更

4. エラーケースのテスト
   - **APIキーが間違っている場合のエラー処理**
   - **クレジットが入っていない場合のエラー処理**
   - ネットワークエラー時の処理
   - サーバーエラー時の処理

## 実装優先度

特に優先度が高いのは:
- APIキーエラーの適切な処理と表示
- クレジット不足時のエラー処理と表示

## 関連ファイル

- `test/e2e/tests/admin/create-report.spec.ts`
- `test/e2e/utils/mock-api.ts`
- `client-admin/app/create/page.tsx`


**コメント:** なし

---

### [プラポリURL等をhowtoに記載すると良さそう](https://github.com/digitaldemocracy2030/kouchou-ai/issues/393)

**作成者:** nasuka  
**作成日:** 2025-04-29T13:13:43Z  
**内容:**

## 要望内容
改善案
metaデータ以外の変更箇所（フッターのプラポリ・利用規約、テスト環境のページへ）について、howtoもしくはReadMeに記載する。

改善する
変更することを忘れやすく、デバック時も気づかれない可能性がある。
ドキュメントに記載することで、公開前のチェックリストとなる。

---
こちらのイシューはGoogle Form経由で投稿されたものです

**コメント:** なし

---

### [レポート作成時にAPIが正常でない場合にわかりやすいエラーを出す](https://github.com/digitaldemocracy2030/kouchou-ai/issues/391)

**作成者:** devin-ai-integration[bot]  
**作成日:** 2025-04-29T12:10:49Z  
**内容:**

# レポート作成時にAPIが正常でない場合にわかりやすいエラーを出す

## 概要
現在、OpenAI APIキーが無効または期限切れの場合、レポート作成プロセスが途中で失敗し、ユーザーにとって原因がわかりにくい状態になっています。APIの状態に問題がある場合に、より明確なエラーメッセージを表示する機能が必要です。

## 背景
Windows環境セットアップガイドの改善（PR #387）の議論中に、APIキーの有効性チェックについて検討されました。セットアップスクリプト（setup_win.bat）での実装は複雑さを増すため見送られましたが、アプリケーション本体でのエラーハンドリング改善は有用と判断されました。

参考: https://chatgpt.com/share/68107163-fecc-8009-b2a3-125f8c8d8310

## 提案される改善点
1. レポート作成開始時にAPIの健全性チェックを行う
2. APIキーが無効または期限切れの場合、わかりやすいエラーメッセージを表示
3. APIサーバーに接続できない場合のネットワークエラー処理
4. エラーメッセージは技術的な詳細ではなく、ユーザーが取るべき行動を明確に示す

## 実装案
- APIリクエスト前に簡単な健全性チェック（例: `/v1/models`エンドポイントへのリクエスト）
- エラーコードに応じた適切なメッセージ表示
  - 401: APIキーが無効または期限切れ
  - 429: レート制限に達した
  - その他: ネットワーク接続の問題など

## 期待される効果
- ユーザー体験の向上
- トラブルシューティングの簡素化
- サポート負担の軽減


**コメント:** なし

---

### [[FEATURE]ローカルLLM / embedding を利用できるようにする](https://github.com/digitaldemocracy2030/kouchou-ai/issues/385)

**作成者:** nasuka  
**作成日:** 2025-04-29T03:57:58Z  
**内容:**

# 背景
* 現在はOpenAI/Azure OpenAI のLLMのみをサポートしているが、アカウント登録・契約のハードルがあり、利用できないユーザーがいる
* 特に個人のユーザーではなく、自治体などの組織においては最初のアカウント作成がボトルネックになるケースがある
  * 出力の品質は下がるが、ローカルLLMの出力でもある程度参考になるアウトプットを出せる可能性がある
    * また、どのようなアウトプットが出るのかイメージできると、本格導入の話も進みやすくなる


# 提案内容
* ローカルLLMおよびembeddingを利用できるようにする
  * 事前に実験を行ったうえで、利用するLLM/embeddingを選定する
    * 要件としては、[こちら](https://gist.github.com/nishio/469b5dc420c77b359ef43f3bdfb11526) に記載されているスペックのマシンで動作すると良さそう（メモリ16GB以内）
* UIとしては、管理画面の「AIモデル」のセレクトボックスにローカルLLMのモデル名を追加する 
  * embeddingの選択フォームは現状存在しないので新設する

![Image](https://github.com/user-attachments/assets/f1cbd478-be65-4dfa-93fb-f980e598c39f)

**コメント:** なし

---

### [基本的なE2Eテスト環境構築 (Basic E2E Test Environment Setup)](https://github.com/digitaldemocracy2030/kouchou-ai/issues/380)

**作成者:** devin-ai-integration[bot]  
**作成日:** 2025-04-25T11:56:02Z  
**内容:**

# 基本的なE2Eテスト環境構築 (Basic E2E Test Environment Setup)

## 概要 (Overview)
E2Eテスト導入の第一歩として、Playwrightを使用した基本的なテスト環境を構築します。最小限のテストケースで環境の動作確認を行い、GitHub Actionsでの実行設定を整えます。

## タスク (Tasks)
1. Playwright導入
   - client-adminディレクトリにPlaywrightをインストール
   - 基本的な設定ファイル（playwright.config.ts）の作成
   - テストディレクトリ構造の設定

2. 最小限のテストケース作成
   - レポート作成ページへのアクセステスト
   - 基本的なUI要素の存在確認テスト

3. GitHub Actions設定
   - 1日1回の定期実行設定（cronジョブ）
   - PRラベル（`e2e-test-required`）によるトリガー設定
   - テスト結果のアーティファクト保存設定

4. モック戦略の基本設定
   - APIエンドポイントのモック設定
   - 認証のモック設定

## 成功基準 (Success Criteria)
- Playwrightが正常にインストールされ、基本的なテストが実行できる
- GitHub Actionsで定期実行とラベルトリガーが機能する
- テスト結果がアーティファクトとして保存される
- 最小限のテストケースが安定して動作する

## 注意点 (Considerations)
- 最初は最小限の設定で始め、徐々に拡張する
- テストの安定性を重視し、不安定な要素は避ける
- 開発者が簡単にローカルでテストを実行できるようにする

## 関連Issue
- #379 （親イシュー：E2Eテスト導入計画）


**コメント:** なし

---

### [E2Eテスト導入計画 (E2E Testing Implementation Plan)](https://github.com/digitaldemocracy2030/kouchou-ai/issues/379)

**作成者:** devin-ai-integration[bot]  
**作成日:** 2025-04-25T10:56:23Z  
**内容:**

# E2Eテスト導入計画 (E2E Testing Implementation Plan) - 更新

## 概要 (Overview)
レポート作成時に編集したプロンプトが反映されないバグのような状態管理の問題を早期に検出するため、E2Eテストを導入します。コスト効率と保守性を考慮した段階的なアプローチを取ります。

## 目的 (Goals)
- 重要なユーザーフローの動作を自動的に検証する
- リファクタリングによる回帰バグを早期に発見する
- 開発者の負担を最小限に抑えつつ、品質を向上させる

## アプローチ (Approach)
- Playwrightを使用したE2Eテスト
- 重要なフローに絞ったテスト作成
- 1日1回の全テスト実行 + PRラベルによる選択的実行
- Devinによるテストメンテナンス自動化

## 実装計画 (Implementation Plan)

### 現在進行中のサブイシュー
- [#380 基本的なE2Eテスト環境構築](https://github.com/digitaldemocracy2030/kouchou-ai/issues/380)

### 将来の実装メモ（サブイシューではなく参考情報として）
以下の項目は、最初のステップ（#380）で得られる知見を元に、必要に応じて調整・実装していきます。

#### 2. プロンプト編集テスト実装
- プロンプト編集の永続性テスト
- ページ内ナビゲーション後のプロンプト保持テスト
- エラー発生時のプロンプト保持テスト

#### 3. 基本的なユーザーフローテスト実装
- CSVファイルによるレポート作成テスト
- スプレッドシートによるレポート作成テスト

#### 4. テストメンテナンス自動化
- テスト失敗の自動検出
- Devinによる修正PR作成ワークフロー
- テスト結果レポート自動化

#### 5. 開発者ガイドライン作成
- E2Eテスト実行方法ドキュメント
- テスト追加・修正ガイドライン
- テスト失敗時のトラブルシューティング

## 実装順序 (Implementation Order)
1. 基本環境構築（最小限のテストで検証）- 進行中 #380
2. プロンプト編集テスト（今回のバグ対策）
3. 基本フローテスト（主要機能の保護）
4. メンテナンス自動化（持続可能性の確保）
5. ドキュメント整備（開発者体験の向上）

## 注意点 (Considerations)
- テストの安定性を重視（不安定なテストは無効化）
- セレクタは壊れにくい方法で指定（ID属性など）
- テスト失敗時の詳細なレポート生成
- コントリビュータへの影響を最小化

## 関連Issue
- #375 （プロンプト編集バグ）
- #377 （リファクタリングのrevert）
- #380 （基本的なE2Eテスト環境構築）


**コメント:** なし

---

### [[FEATURE] OpenAIのBatch APIで、レートリミットを迂回する](https://github.com/digitaldemocracy2030/kouchou-ai/issues/374)

**作成者:** tokoroten  
**作成日:** 2025-04-25T06:58:37Z  
**内容:**

# 背景
openaiのtireが低いと、レートリミットが発生してブロックされる

# 提案内容
OpenAIや、AzureOpenAIにバッチで投げている部分は、batchapiにする。

https://platform.openai.com/settings/organization/limits

batch apiは、レートリミットが通常のAPIよりも大きい
https://platform.openai.com/docs/guides/batch

副次的効果として、LLMコストが下がる

**コメント:** なし

---

### [[FEATURE]パブコメ大量投稿への対策として省庁が実用可能なツールを作る](https://github.com/digitaldemocracy2030/kouchou-ai/issues/370)

**作成者:** nishio  
**作成日:** 2025-04-25T02:49:36Z  
**内容:**

# 背景(Devin)

## 概要
「[FEATURE]embvec_reduce_public_commentをベースに省庁が実用可能な形に仕上げる」は、実験的に開発された埋め込みベクトルを使った重複パブリックコメント削減機能を、実用レベルに仕上げるための機能要望です。

## 背景
- Issue #345「（情報整理）同一の内容が大量に投稿される問題への対処法」が親イシューとなっています
- パブリックコメントで同一内容が大量に投稿される問題があり、以下の課題が発生:
  1. フロントエンドの処理負荷増大（数万件規模のデータ描画が困難）
  2. バックエンドの処理負荷・APIコスト増大
  3. ユーザーの認知負荷増大（スパム的意見が大半を占め、重要な意見が埋もれる）

## 実験的アプローチ
- 実験ディレクトリ `experimental/embvec_reduce_public_comment` に、SentenceTransformerを使った埋め込みベクトル計算と重複排除のコードが実装されています
- このコードは以下の処理を行います:
  1. SentenceTransformerでコメントの埋め込みベクトルを生成
  2. コサイン類似度に基づく階層的クラスタリングで類似コメントをグループ化
  3. 各クラスタの中心に最も近いコメントを代表として抽出
  4. 結果をExcelファイルに出力

## 現在の状況
- 実験コードは作成済みで、Issue #370ではこれを実用レベルに仕上げることが目標
- 省庁が実際に使えるレベルの完成度を目指している


# 提案内容(nishio)

- Minimum Viable Productとして最低限省庁内の担当者が利用可能なスクリプトとREADMEを作成する
- 何らかのデータで実際に使ってみて「これを使うとこうなる」と語れる参考事例を作る

**コメント:** なし

---

### [[DOCUMENT] 元データの特徴に合わせたextractionプロンプトのガイドライン](https://github.com/digitaldemocracy2030/kouchou-ai/issues/367)

**作成者:** mtane0412  
**作成日:** 2025-04-23T13:46:14Z  
**内容:**

# 背景
extractionで「意見を抽出するプロンプト」で「意見」を抽出できなかったときに、few-shotの文が出てきたり意見を作ってしまう現象が既知の問題としてある。
2025/4/23 段階ではプロンプトよって改善可能であるという意見が多かった。
システムが自動で消してしまうのもよくないという意見があった。

ユーザーがプロンプトを改善できるガイドラインのようなものがあってもいいという発言があったと思い、同じ意見なのでissueにしておく

> extractionの品質の管理は課題として認識していたりします。
> 多くの利用者の信頼感を高めるうえでは大事になりそう。
> 
> なるほど、意見のないものから意見を抽出しようとしているのか...(nishio)
> クレンジングか、few-shot promptですね
> 意見抽出ツールを意見抽出でないことに使おうとしてるので汎用的に品質向上は難しいからユーザのブロンプトを調節するのがいちばん筋だと思う
> システムとして自動的に消すのはよくないのではという議論、そうだと思う、何がゴミで何が取りたいものかを決めるのは受け取り手が決めるものなので我々が決めることではない
> パンプキンパイのレシピが混ざってたら、たくさんの意見として抽出された(tanenobu)
> 不思議な出力を選択して元コメントを調べたり、それらをログ的に出力できると改善にまわせそう
> 私も標準でやったときに結構盛られましたわ。(kitaro)

![](https://i.gyazo.com/3e07293e28f06c3e3404b8db045774a6.png)

> こういう入力が来るなら、few-shotでキーワードを抽出するように指示すればいいと思う(nishio)
> いまはサンプルとして「意見のリスト」を返すように指示しているから、意見が生成される。キーワードのリストを返せと例示すればキーワードのリストが返る。

> アプローチはプロンプトだけなのか、など相談できれば。
> (nasuka)デフォルトのプロンプトで上記の事象が発生してるんでしょうか？基本的にはプロンプト改善 or  モデルの変更で> 対処するのが良さそうで、ルールベースで弾く機能を入れるのも案としてはあると思います
> 元のコメントよりも明らかに文字数が増えている場合は弾くなど
> （LLMでチェックするプロセスを入れることも可能だが、解決策としてはオーバーな気がする）
> (nishio)デフォルトのプロンプトで、十分賢いモデルならこうはならないのではという気もするが、とはいえ起きてるのであれば、ごく短い入力に関してはもっと「空リストを返す」という振る舞いをするようにプロンプトを変えてもいいかもですね
> ブロンプトの試行錯誤がやりやすくなる機能はあるとベターではある
> うまくいってない入力と出力のペアが集まると色々やりやすくはなると思います(nishio)
> たとえば上記CSVをo3にぶちこんで不適切な抽出だと思うものを取り出してもらうとか


# 提案内容
うまくいっていない例を収集する仕組みや活動が必要
> 不思議な出力を選択して元コメントを調べたり、それらをログ的に出力できると改善にまわせそう
> うまくいってない入力と出力のペアが集まると色々やりやすくはなると思います(nishio)

収集したものをもとにガイドライン的なドキュメントにまとめる。
(UIにも組み込むとよいと思いましたが、まずはドキュメント化が先かなと思いました。)

**コメント:** なし

---

### [[FEATURE] 複数の公開リスト](https://github.com/digitaldemocracy2030/kouchou-ai/issues/366)

**作成者:** mtane0412  
**作成日:** 2025-04-23T13:28:58Z  
**内容:**

# 背景

現在作成されたすべてのレポートが単一のリストに追加されるようになっている。
レポートの中には関連して作成されるレポートなどもある。

会議ログの補足で、

> 複数のシリーズレポートのシェアで不便になりそう(aruga)

シリーズレポートに関しては現場で実際に作られているが、リスト機能のニーズを直接確認したわけではないので現状まだ high priority ではない。
公開非公開の議論の中で個別認証時に不便になりそうという意見。


2025/4/23 定例
> レポートの限定公開ステータスの需要が少し気になってます！
> boolから型を変えるので後方互換もあるので、思ったより面倒かもしれないので。
> YouTubeのunlistedみたいなもの
> Clientのトップに単一のリストがあって自動的にそこに入って公開されてしまう(nishio)
> そもそもデフォルトpublicでlistedだったら公開したくないものも作成した瞬間公開されてしまう問題があるのでは
> YouTubeみたいにデフォルトprivateかせめてunlistedじゃないといけないのでは
> 管理画面同様にBASIC認証をかける？(nasuka)
> レポートごとに個別のパスワードを設定できればいいのでは(nishio)
> 複数のシリーズレポートのシェアで不便になりそう(aruga)
> そういう意味ではそもそもリストが複数作れないといけないのでは(nishio)


# 提案内容
リストを複数作成でき、レポートをリストに登録できる

**コメント:** なし

---

### [[FEATURE] レポートがデフォルトで公開されないようにする](https://github.com/digitaldemocracy2030/kouchou-ai/issues/365)

**作成者:** mtane0412  
**作成日:** 2025-04-23T13:24:06Z  
**内容:**

# 背景

> そもそもデフォルトpublicでlistedだったら公開したくないものも作成した瞬間公開されてしまう問題があるのでは

サーバーを公開している状態で、作成直後にpublicとして出力される問題がある。
現在の仕様だと、isPublic = falseなレポートは管理者でも表示ができない。

2025/4/23 定例
> レポートの限定公開ステータスの需要が少し気になってます！
> boolから型を変えるので後方互換もあるので、思ったより面倒かもしれないので。
> YouTubeのunlistedみたいなもの
> Clientのトップに単一のリストがあって自動的にそこに入って公開されてしまう(nishio)
> そもそもデフォルトpublicでlistedだったら公開したくないものも作成した瞬間公開されてしまう問題があるのでは
> YouTubeみたいにデフォルトprivateかせめてunlistedじゃないといけないのでは
> 管理画面同様にBASIC認証をかける？(nasuka)
> レポートごとに個別のパスワードを設定できればいいのでは(nishio)
> 複数のシリーズレポートのシェアで不便になりそう(aruga)
> そういう意味ではそもそもリストが複数作れないといけないのでは(nishio)

# 提案内容
デフォルトで非公開、もしくは限定公開( #341 )のようにアクセスできないようにする。
非公開であっても管理者が作成されたレポートを確認できるようにする。

**コメント:** なし

---

### [[FEATURE] 個別レポートのパスワード認証](https://github.com/digitaldemocracy2030/kouchou-ai/issues/364)

**作成者:** mtane0412  
**作成日:** 2025-04-23T13:18:12Z  
**内容:**

# 背景

#341 関連で、個別レポートに認証をかけてよりセキュアにシェアできる機能は、優先度はさておきあってもよい機能ではあると思うのでissueだけ立てておく。

2025/4/23 定例
> レポートの限定公開ステータスの需要が少し気になってます！
> boolから型を変えるので後方互換もあるので、思ったより面倒かもしれないので。
> YouTubeのunlistedみたいなもの
> Clientのトップに単一のリストがあって自動的にそこに入って公開されてしまう(nishio)
> そもそもデフォルトpublicでlistedだったら公開したくないものも作成した瞬間公開されてしまう問題があるのでは
> YouTubeみたいにデフォルトprivateかせめてunlistedじゃないといけないのでは
> 管理画面同様にBASIC認証をかける？(nasuka)
> レポートごとに個別のパスワードを設定できればいいのでは(nishio)
> 複数のシリーズレポートのシェアで不便になりそう(aruga)
> そういう意味ではそもそもリストが複数作れないといけないのでは(nishio)



# 提案内容

BASIC認証

**コメント:** なし

---

### 過去7日間に更新されたissue（作成・クローズを除く）(25件)

### [(実験) 同一の内容が大量に投稿される問題への対処法](https://github.com/digitaldemocracy2030/kouchou-ai/issues/346)

**作成者:** nasuka  
**作成日:** 2025-04-21T05:54:34Z  
**内容:**

# 背景
https://github.com/digitaldemocracy2030/kouchou-ai/issues/345
上記のIssueに紐づく実験のIssue

以下元Issueの背景を転載
* [パブコメの大量投稿](https://x.com/takahiroanno/status/1914151807443718381) によって、入力データの中に似通った内容が大量に含まれる場合がある
* これによって、以下の問題が起きる
  * 1.フロントの処理負荷が高くなる
    * 現在の設計では、数万件〜規模のデータは描画の負荷が高くPCによっては正常に表示できない可能性がある
  * 2.バックエンドの処理負荷・コストが高くなる
    * レポート出力処理の際のクラスタリングの計算負荷が高くなる・extraction処理にかかるLLM APIのコストが高くなる
  * 3.ユーザーの認知負荷が高くなる
    * 今の形式でクラスタリングや可視化を行うと、スパム的な意見が意見全体の大半を占めるために、本来着目したい意見が目立たなくなってしまう可能性がある


# 提案内容
* 類似する意見をあらかじめまとめたうえで、まとめた後の意見を広聴AIの分析にかける。
  * まとめた後の意見が表示されるようになることで、フロントの処理負荷が下がり、またユーザーの認知負荷も下がる
  クラスタよりもより細かい粒度で、「ほとんど同じことを言っている意見」がまとめられると良さそう？（あくまで一案で、この粒度でまとめるのがマストではない）
* まとめ方には幾つかのアプローチがありそう。
  * e.g. クラスタリングでまとめる、LLMでまとめる、そのハイブリッド等

↑は問題解決の一つのアプローチの案として記載していますが、他にアプローチがあれば随時コメントにご記載ください。

## 想定する進め方
* 実験データの選定（or 作成）
* 実験データに対して、アルゴリズムを適用し、アウトプットを確認
  * * @nishio , @nasuka （+ 時間があれば@takahiroanno も）あたりは確認しておけると良さそう
* 問題なさそうであれば機能実装の検討に移る




**コメント:** なし

---

### [（情報整理）同一の内容が大量に投稿される問題への対処法](https://github.com/digitaldemocracy2030/kouchou-ai/issues/345)

**作成者:** nasuka  
**作成日:** 2025-04-21T05:40:51Z  
**内容:**

# 背景
* [パブコメの大量投稿](https://x.com/takahiroanno/status/1914151807443718381) によって、入力データの中に似通った内容が大量に含まれる場合がある
* これによって、以下の問題が起きる
  * 1.フロントの処理負荷が高くなる
    * 現在の設計では、数万件〜規模のデータは描画の負荷が高くPCによっては正常に表示できない可能性がある
  * 2.バックエンドの処理負荷・コストが高くなる
    * レポート出力処理の際のクラスタリングの計算負荷が高くなる・extraction処理にかかるLLM APIのコストが高くなる
  * 3.ユーザーの認知負荷が高くなる
    * 今の形式でクラスタリングや可視化を行うと、スパム的な意見が意見全体の大半を占めるために、本来着目したい意見が目立たなくなってしまう可能性がある


# 進め方
* アルゴリズムの改善によって上記の問題を解決するかを検討する。
* いきなり機能を実装するのではなく、プロダクトとは独立して実験スクリプトを実装し、検証用のデータセットを使って結果の妥当性を評価する
* 問題なければプロダクトの機能として実装を進める
  * 一旦実験系のIssueだけ立てておき、機能することがわかった段階でプロダクトへの実装イシューを立てる

```
1: 独立したスクリプトとして機能するものを作れるが実験
2: それをapiサーバに統合するか検討
3: それをどんなGUIでユーザに見せるか検討
という流れがスムーズかなと思いました
```

**コメント:** なし

---

### [[FEATURE] レポートの限定公開](https://github.com/digitaldemocracy2030/kouchou-ai/issues/341)

**作成者:** mtane0412  
**作成日:** 2025-04-19T14:49:51Z  
**内容:**

# 背景
- レポートの公開ステータスは公開と非公開で、非公開にした場合、管理者であってもレポートページを参照することができない
- 面白いレポートができたので他人に共有したいが、一般に広く公開したいわけではないものがある。既に作成したデータも公開しているので、部分公開しようと思うと手間がかかる。


# 提案内容
- Youtubeの限定公開のように、URLを知っている人だけがアクセスできるレポートページの状態を作る
- 単純にトップページからリンクされないように出力すればできる？

**コメント:** なし

---

### [[FEATURE] static exportしたHTMLファイルをwebサーバーなしで閲覧できるようにする](https://github.com/digitaldemocracy2030/kouchou-ai/issues/333)

**作成者:** nasuka  
**作成日:** 2025-04-18T08:28:41Z  
**内容:**

# 背景
* static exportしたhtmlファイルについて、現在はwebサーバーにhtmlを配置しないと閲覧できないという問題がある。
  * 添付したスクショの様にエラーが発生し、データ・スクリプト・画像等が読み込めない
* この問題により、閲覧する際にWebサーバーが必須となるためレポートを共有するハードルが高い

![Image](https://github.com/user-attachments/assets/40e25d38-31d3-4517-90e2-d3e2bb14b7cf)

# 提案内容
Webサーバーなしで閲覧できるhtmlファイルを作成できるようにする。
自分がフロントに余り詳しくなく、上記を実現するための具体的なアプローチを思いつく方はコメントいただけると助かります。


**コメント:** なし

---

### [（実験）ファクトチェックロジックの実験](https://github.com/digitaldemocracy2030/kouchou-ai/issues/324)

**作成者:** masatosasano2  
**作成日:** 2025-04-17T14:09:02Z  
**内容:**

# 背景
各サービスでファクトチェックが必要とされている。
ファクトチェック処理は共通化できるので、本Issueはその共通処理を実験するためのIssueとする。
処理のコードをどこに置くべきかはidobata側のリポジトリの統一後に検討する。

# 関連Issue

1. https://github.com/digitaldemocracy2030/kouchou-ai/issues/170
2. https://github.com/digitaldemocracy2030/idobata-analyst/issues/97
3. https://github.com/digitaldemocracy2030/idobata-discourse-agent/issues/51
4. https://github.com/digitaldemocracy2030/idobata/issues/17

# 関連Issue1から抜粋

<img width="600" alt="Image" src="https://github.com/user-attachments/assets/5968bb66-9070-4a84-b0cb-170205f319e5" />

# 提案内容

- 実装方針：どこかで議論されていたとおり怪しいものは弾かずOKにして、明確に偽情報と判断した場合のみ弾く。
- 準備：偽情報を含みそうな適当なデータセットを用意し、人力で正解データを作る。
- 実験概要：以下のコストや精度を比較する。他のアプローチがあれば随時試す。
    - 既存のファクトチェックサービスで偽と判定された場合のみNGとする
    - いくつかの信用できる情報源を指定し、そこから取得できる事実から偽と判定された場合のみNGとする
    - 単純なWeb検索の結果から偽と判定された場合のみNGとする
    - DeepResearch的な仕組を自作し、それに偽と判定された場合のみNGとする
    - 既存のDeepResearch系のサービスで偽と判定された場合のみNGとする

**コメント:** なし

---

### [[FEATURE]CSVアップロード時にタイトルや説明文を自動で埋めてほしい](https://github.com/digitaldemocracy2030/kouchou-ai/issues/305)

**作成者:** masatosasano2  
**作成日:** 2025-04-13T07:45:30Z  
**内容:**

# 背景
入力の一手間を減らしたい
入力漏れでエラーにならないでほしい

# 提案内容
- タイトルと説明文を optional にする
- 空の場合にCSVの内容から自動生成する　※説明文は必須でないかも

**コメント:** なし

---

### [[FEATURE]「公開」ボタンを押した時の効果を分かりやすくする](https://github.com/digitaldemocracy2030/kouchou-ai/issues/302)

**作成者:** masatosasano2  
**作成日:** 2025-04-13T06:51:12Z  
**内容:**

# 背景
キャプションが「公開」の状態のボタンを押すと非公開になり、「非公開」の状態のボタンを押すと公開になる。
キャプションの意味は現在の状態であってボタンを押した時に発生するアクションではないので間違ってはいないのだが、
client-adminでもclientでも大抵のボタンのキャプションは押した時のアクションに近いので、やや紛らわしい。

# 提案内容
- 案1：マウスオーバー中のみ「非公開にする」「公開にする」などのヒントを表示する
- 案2：マウスオーバー中のみ逆の状態の見た目にする
- 案3：ボタンからスイッチに変える
- 案4：ボタンからチェックボックスに変える　＊この場合、「非公開にする」チェックの方が自然かも

**コメント:** なし

---

### [[FEATURE]ラベルが多い時の重なりの問題](https://github.com/digitaldemocracy2030/kouchou-ai/issues/294)

**作成者:** nishio  
**作成日:** 2025-04-13T00:59:47Z  
**内容:**

## 課題

広聴AIのレポート画面に表示されるプロットグラフにおいて、分析によって生成されたクラスタ（意見グループ）の数が多い場合に、各クラスタを示すラベルが互いに重なり合ってしまい、判読が困難になるという問題があります。

特に、自治体での利用など、詳細な分析のためにクラスタを細かく分ける傾向がある場合に、この見にくさが顕著になります。
> 「自治体的には、クラスタを細かく分ける方向の議論が強い。」
> 「UIの観点で、プロットグラフがそれに対応していけるとよさそう。」
> 「ラベルは重なって見にくくならないようにできるとか」

現状のままでは、せっかく詳細に分類された意見グループの内容を、グラフ上で直感的に把握することが難しくなっています。

## 解決策案

グラフ上でのラベルの重なりを軽減し、視認性を向上させるために、以下のいずれか、または組み合わせによる改善策を検討します。

*   **ラベル表示の選択的ON/OFF:** ユーザーが表示したいラベルを選択したり、一定数以上のラベルはデフォルトで非表示にする機能を追加する。
    > 「ラベル全部は表示しない設定」
*   **重なり回避アルゴリズムの導入:** ラベルの位置を自動的に調整し、重なりを最小限に抑えるアルゴリズムを実装する。
*   **インタラクティブなラベル操作:** ユーザーがグラフ上でラベルをドラッグ＆ドロップして任意の位置に移動できるようにする。
*   **ズームレベルに応じた表示制御:** グラフの拡大率に応じて、表示するラベルの数を調整する（例: 縮小時は主要なラベルのみ表示）。

**コメント:** なし

---

### [[DOCUMENT]OpenAI APIの課金設定に関する混乱](https://github.com/digitaldemocracy2030/kouchou-ai/issues/292)

**作成者:** nishio  
**作成日:** 2025-04-13T00:52:56Z  
**内容:**

# 現在の問題点
非エンジニアにとって、OpenAI APIキーの取得と課金設定（クレジット購入）が必要であることが分かりにくく、ChatGPT Plusと混同しやすい。設定不備によりQuota超過エラー (429) が発生する。

「OpenAIの課金の設定してなかった」
「Error code: 429 - 'You exceeded your current quota, please check your plan and billing details.'」
「非エンジニアの場合、環境を設定した際にOpenAI APIに課金するというステップがわからない(たねのぶ)」
「OpenAIに課金=ChatGPT Plusだと思う人もいる」

# 提案内容
<!-- どのようなリファクタリングを提案するのか、具体的に説明してください -->
(解決策) READMEに、OpenAI APIキーの取得手順と、ChatGPT Plusとは別にAPI利用のためのクレジット購入（支払い方法登録）が必要であることを明記する。Quota超過エラーの意味と対処法も説明する。


**コメント:** なし

---

### [[FEATURE]階層図のUI/UX改善](https://github.com/digitaldemocracy2030/kouchou-ai/issues/290)

**作成者:** nishio  
**作成日:** 2025-04-13T00:49:58Z  
**内容:**

# 背景
階層図の操作性や情報表示に改善の余地がある (クリック操作の分かりにくさ、表示リセット、親子関係不明瞭、命名規則、戻るボタン欠如)。

from 4/12 meetup
>「階層図のギミックを確認、初見でクリックによって深層に移動できることがわからなかった。」
「全体図、濃い意見グループ、階層図を行き来するときに階層図の表示がリセットされなくなるとうれしい。」
「濃い意見グループで上がってきているクラスタが第一階層？のクラスタのどれに属すのかがわかるとうれしい。」
「階層図の第一階層？第二階層の名前が決まっていると嬉しい。」
「「１階層前に戻る」ボタンがあると助かります」

# 提案内容
(解決策) クリック操作のガイド表示、表示状態の保持、親子関係の明示（例: パンくずリスト）、階層命名規則の明確化、戻るボタンの追加など、UIを改善する。


**コメント:** なし

---

### [[FEATURE]利用可能なLLMを増やす](https://github.com/digitaldemocracy2030/kouchou-ai/issues/285)

**作成者:** nishio  
**作成日:** 2025-04-12T23:50:46Z  
**内容:**

# 背景
現在OpenAI APIのみ対応しており、Gemini無料枠やLocalLLMなど他の選択肢を利用できない。

from 4/12 meetup
>「Geminiの無料枠をOpen AI互換で使えたりする？」
「他LLM対応はうれしい（LocalLLMなど）」
「Local LLM(OpenAI互換)、embeddingなどで開発はケチりたい」
「idobataの方ではopenrouterが使われているのに対して、kouchouではopenaiが使われているのが不便に思った。統一してくれるとありがたいと思う。」


<!-- なぜその機能が必要なのか、何が改善されるのか具体的に記入してください -->


# 提案内容
<!-- 実装案やデザイン案があれば記入してください -->
>Gemini API、OpenRouter API、OpenAI互換のLocalLLMなど、複数のLLMに対応する。

(nishioコメント) OpenRouter APIには追加で対応してもいいかもしれない、ただし「統一」はありえない(OpenRouterを使えないユーザを締め出すことになるから)

**コメント:** なし

---

### [[BUG] 静的ファイルがGithub Pagesでうまく表示されない件](https://github.com/digitaldemocracy2030/kouchou-ai/issues/274)

**作成者:** keisuke-a  
**作成日:** 2025-04-10T06:52:19Z  
**内容:**

### 概要

静的ファイルをoutして、その中身をgithub pagesで公開すると、out/index.html自体は表示はされるが、画像要素がなかったりリンク先（個別ページ）が404になるなど、うまく表示されない。（参照が絶対パスになってることによる？）


**コメント:** なし

---

### [(情報整理)Windows環境で試す人のためのガイドが必要](https://github.com/digitaldemocracy2030/kouchou-ai/issues/254)

**作成者:** nishio  
**作成日:** 2025-04-08T03:14:53Z  
**内容:**

Windows環境で試す人の踏みそうなトラブルシューティング

西尾も角野さんもMacなのでどんなトラブルが起きるのかを観測できてない感、issueでもslackでもガンガン書いてもらえるといいと思う

Windows環境で試すとなった時に、まずいきなり「生環境でやる」「WSLでやる」「Dockerでやる」の3つの選択肢があると思ってて、どれが一番スムーズなのかはよくわかってない、Windows環境のある人の協力があるとありがたいゾーン

関連Slack: https://w1740803485-clv347541.slack.com/archives/C08F7JZPD63/p1744081553571589

**コメント:** なし

---

### [[DOCUMENT] README に GitHub Pages で公開する手順を記載する](https://github.com/digitaldemocracy2030/kouchou-ai/issues/235)

**作成者:** shgtkshruch  
**作成日:** 2025-04-05T07:07:57Z  
**内容:**

# 現在の問題点
<!-- 現在のコードの何が問題なのか、どのような技術的負債があるかを説明してください -->

- client を static build して GitHub Pages で公開する場合、ビルドしたファイルをアップロードすると一部のコードが動かない
  - 原因: GitHub Pages で動いている Jekyll が `_` から始まるファイルやディレクトリを無視するため、static build 後の `_next` 以下のファイルが 404 になる
    - https://github.blog/news-insights/the-library/bypassing-jekyll-on-github-pages/
  - `.nojekyll` というファイルをルートに置くと動くようになるが、この挙動は知らない人が多そうで GitHub Pages で公開する人が同じ罠にハマる可能性がある

# 提案内容
<!-- どのようなリファクタリングを提案するのか、具体的に説明してください -->

- README の静的ファイル出力のセクションに、GitHub Pages で公開する場合の手順を記載する
  - ルートに `.nojekyll` ファイルを追加することもここに記載する

**コメント:** なし

---

### [(情報整理)試行錯誤の負担を減らす](https://github.com/digitaldemocracy2030/kouchou-ai/issues/221)

**作成者:** nishio  
**作成日:** 2025-04-02T11:45:10Z  
**内容:**

とりあえず立てて、あとで詳細化します

from 4/2定例
>使うまでの準備工数に認識のギャップがある
>プロンプトやクラスタ数等、様々なチューニングを行う必要があるが、その認識がない
>試行錯誤の負担を減らす必要がある(& ドキュメント？)

>自治体の典型的な使い方がわかったら型を示せる

>100件、1000件とサンプリングする？→黙ってやると有害、確認ダイアログがあるといい

- クラスタ数の変更はextraction, embeddingが終わった後のデータでスピーディにできる 関連: https://github.com/digitaldemocracy2030/kouchou-ai/issues/19
- extractionの試行錯誤の負担を減らす仕組みが必要

- いきなり1万件入れて1時間くらい待たされる →　https://github.com/digitaldemocracy2030/kouchou-ai/issues/11

- https://github.com/digitaldemocracy2030/kouchou-ai/issues/241

**コメント:** なし

---

### [[FEATURE]LLMベースの分類機能の実装](https://github.com/digitaldemocracy2030/kouchou-ai/issues/176)

**作成者:** nasuka  
**作成日:** 2025-03-25T08:30:43Z  
**内容:**

# 背景
* 既存の階層クラスタリングアルゴリズムは以下の課題がある
  * ある程度データの件数が存在することを前提としている（小規模データだとワークしにくい）
  * embeddingに基づいてデータをまとめているため、クラスタリングの品質がembedding（およびUMAP後の2次元ベクトル）の品質に依存する


# 提案内容
LLMベースの分類機能を実装する。これは以下の2つの方向性がある。

1. 分類するトピックをLLMで自動で構築するパターン
  a. データから、どのようなトピックがあるかを自動で推定し、各意見をトピックに分類する
  b. 参考: [sensemaking](https://medium.com/jigsaw/making-sense-of-large-scale-online-conversations-b153340bda55)
2. 分類するトピックを人間が付与するパターン
  a. 意見を所与のトピックに分類する
  b. あらかじめ決められたトピックに意見を分類したい場合に活用できる

あった方が良い機能であるように思う一方で、既存のクラスタリングベースのアルゴリズムとこの機能をどう同居させるかが悩ましい。
既存のレポートは見せ方も異なってくると思われるので、別形式のページを出力するのが一案。

# 進め方について
* いきなり機能を実装するのではなく、プロダクトとは独立して実験スクリプトを実装し、検証用のデータセットを使って結果の妥当性を評価する
* 問題なければプロダクトの機能として実装を進める
  * 一旦実験系のIssueだけ立てておき、機能することがわかった段階でプロダクトへの実装イシューを立てる

**コメント:** なし

---

### [[FEATURE]グラウンディングの実験](https://github.com/digitaldemocracy2030/kouchou-ai/issues/173)

**作成者:** nasuka  
**作成日:** 2025-03-25T08:10:43Z  
**内容:**

# 背景
https://github.com/digitaldemocracy2030/kouchou-ai/issues/172
* 上記のイシューに記載しているグラウンディングの実験を行う


# 実施内容
以下を実施する想定

* グラウンディング処理を行う実験スクリプトを実装
* 検証データに対してグラウンディングされたクラスタ説明文を出力
* 結果を確認し、問題なければプロダクトの機能として実装する
  * 確認のプロセスについては要検討

**コメント:** なし

---

### [[FEATURE]クラスタ説明文におけるグラウンディングの実装](https://github.com/digitaldemocracy2030/kouchou-ai/issues/172)

**作成者:** nasuka  
**作成日:** 2025-03-25T08:07:39Z  
**内容:**

# 背景
* クラスタの説明文では所属する意見の内容を解説しているが、本当にそのような意見が存在するのか確認するのに手間がかかる
* レポートの説得力を増す上で、説明の根拠となる元データを簡単に参照できるようにしたい


# 提案内容
* クラスタ説明文において、その根拠となるargumentを紐づけたテキストを表示する
  *  参考: https://medium.com/jigsaw/making-sense-of-large-scale-online-conversations-b153340bda55
    * Groundings
    * 紐づけ方・紐づけた文章の生成のさせ方は様々なアプローチがあるので、アプローチを検討する部分からassigneeの方にお任せする

# 進め方について
* いきなり機能を実装するのではなく、プロダクトとは独立して実験スクリプトを実装し、検証用のデータセットを使って結果の妥当性を評価する
  * 問題なければプロダクトの機能として実装を進める
  * 一旦実験系のIssueだけ立てておき、機能することがわかった段階でプロダクトへの実装イシューを立てる



**コメント:** なし

---

### [（実験）LLMによるクラスタ品質の自動評価](https://github.com/digitaldemocracy2030/kouchou-ai/issues/144)

**作成者:** nasuka  
**作成日:** 2025-03-25T03:36:54Z  
**内容:**

# 背景
https://github.com/digitaldemocracy2030/kouchou-ai/issues/143

* こちらのイシューは上記のサブイシュー


# 提案内容
* LLMによるクラスタ品質の自動評価の実験を行う
  * 出力されたクラスタタイトル・説明文・所属データ点の情報に基づいて、LLMでクラスタの品質を評価する
* どのようなアプローチで評価するかは、assigneeの方におまかせする
  * 例としては、例えば以下のような評価項目のスコアをLLMで出力するようなアプローチがある
    * クラスタ内部の一貫性評価
      * クラスタタイトル・説明文・所属データのテキストを入力し、一貫性を100点満点でスコアリングする
    * クラスタ外部との分離度の評価
      * クラスタAの情報（タイトルや所属データ等）と、重心の距離が最もAに近いクラスタBの情報をLLMに入力し、分離度を出力する


**コメント:** なし

---

### [[FEATURE]クラスタ品質の自動評価](https://github.com/digitaldemocracy2030/kouchou-ai/issues/143)

**作成者:** nasuka  
**作成日:** 2025-03-25T03:35:01Z  
**内容:**

# 背景
* クラスタリング結果が妥当なものになっているのかを検証したい
* 一方で、個別のクラスタを人手で評価するのは非常に労力がかかる
  * 50件のクラスタについて整合性を確認することは難しい

# 提案内容
* クラスタリングの結果について自動評価を行う
  * アプローチの詳細は個別のサブイシューに記載する

# 進め方について
* いきなり機能を実装するのではなく、プロダクトとは独立して評価スクリプトを実装し、検証用のデータセットを使って評価実験を行う
* 自動評価の結果について妥当性を確認し、問題なければプロダクトの機能として実装を進める
  * 一旦実験系のIssueだけ立てておき、実験結果より自動評価が機能することがわかった段階でプロダクトへの実装イシューを立てる


## 対象データセット
* 文化庁のパブリックコメントのデータセットが使える
  * https://www.bunka.go.jp/seisaku/bunkashingikai/chosakuken/hoseido/r05_07/
* 現在開示請求しているエネルギー庁のパブコメのデータも使える可能性がある



**コメント:** なし

---

### [[DOCUMENT]ソースコードの実装以外での貢献方法がもっと言語化されるとよい](https://github.com/digitaldemocracy2030/kouchou-ai/issues/130)

**作成者:** nishio  
**作成日:** 2025-03-22T14:31:29Z  
**内容:**

# 現在の問題点
非エンジニアが何をしたらいいかわからない

# 提案内容

例えば
- GitHubのissuesをみて「その問題が解決されると自分も助かる！」と思ったものに:+1:をつけるのはタスクの優先付の参考になるので貢献
- 質問をするのは言語化のきっかけになるので貢献
- 将来的に「AのレポートとBのレポートのどっちがいいですか？」をやる可能性がある、そう言うのに回答してくれるのは貢献

他に思いついたら下にコメントつけてください

**コメント:** なし

---

### [[FEATURE]CSVのフォーマットのエラーをわかりやすくする](https://github.com/digitaldemocracy2030/kouchou-ai/issues/97)

**作成者:** nishio  
**作成日:** 2025-03-19T02:43:19Z  
**内容:**

# 背景
>従来のフォーマット(comment-body)の物をいれると画面遷移せずにトースターでエラーが表示されるがエラーの詳細はないので解決方法が分からなさそう、ここはカラム名の間違い、文字コードがSJIS、BOMがついてる、などなどいろんなハマりバターンが予想されるのでケアできると良さそう


# 提案内容
<!-- 実装案やデザイン案があれば記入してください -->

**コメント:** なし

---

### [[FEATURE]CSVアップロード時にそれを処理した場合のコストを表示](https://github.com/digitaldemocracy2030/kouchou-ai/issues/79)

**作成者:** nishio  
**作成日:** 2025-03-18T03:19:29Z  
**内容:**

# 背景

>安野貴博: ファイルアップロードすると解析掛ける前にコストを教えてくれるの良さそうですね
>ほづみゆうき: ついにレポート出力まで漕ぎ着けたのですがAPI料金がどれくらいになるのかまったく感覚的に分からずドキドキだったので素人にはあると嬉しいと思います！

# 提案内容

これを実現するためには2つの要素が必要

- 1: done( ~~いまCSVアップロード即処理開始になっているが、一旦確認ダイアログを挟む必要がある~~ )
- 2: どのくらいのデータだとどれくらいの費用になるのかの見積もり関数が必要

## (2)の真面目な作り方

(1)は @nanocloudx さんが詳しいと思うが、(2)の部分がわからなくて着手できないと思う。
UI改善に着手する前に、この関数を作るためのデータ自体を集めていないのでそこからやる必要がある。

- a: extraction
- b: embedding
- c: その後のレポート作成

(a)がO(N)でgpt4oなので大きく、(b)はO(N)だがembedding modelなので安く、cはクラスタ数のオーダー(階層モデルなど今回いろいろ追加したから読めない)という感じで、このそれぞれに分けて料金を出せるようにしてデータ量違いでデータを集めればよい。

## (2)の雑な作り方

ユーザのペインは「すごい高額だったらどうしよう」だと思うので、まず「100円未満っすね」「100~1000円くらい」「これはでかいから1000円以上かかるよ」の3段階でいいのでは説

**コメント:** なし

---

### [[FEATURE]濃いクラスタを表示している際は、クラスタの説明文も濃いクラスタに合わせたい](https://github.com/digitaldemocracy2030/kouchou-ai/issues/24)

**作成者:** nasuka  
**作成日:** 2025-03-06T05:36:37Z  
**内容:**

# 背景
* 現状は濃いクラスタ表示した際も、全体図と同じクラスタの説明文が並んでいる（最上位層のクラスタが並んでいる）
  * 添付画像のように、現状は散布図上のタイトルと下部のタイトルが整合しない
![Image](https://github.com/user-attachments/assets/27fde824-7e69-4c3d-8f0a-475ca265b20d)

# 提案内容
* 「濃いクラスタ」が選択されている場合はそれらの説明文を表示したい
  * フィルタされているクラスタの解説文のみをページ下部に表示する






**コメント:** なし

---

### [[FEATURE]レポートの複製・再利用機能](https://github.com/digitaldemocracy2030/kouchou-ai/issues/19)

**作成者:** nasuka  
**作成日:** 2025-03-04T11:38:39Z  
**内容:**

# 背景
* 設定を少しだけ変えて実行したいケースがある
  * 例えばクラスタ数だけ変えるなど


# 提案内容
* レポートの設定複製機能を実装する


# 機能の提供価値
* LLM APIコストの削減
  * レポート出力までのステップを途中から実行できるようになるためAPIのコストを削減できる
* レポート出力の高速化

**コメント:** なし

---

## Pull Requests

### 過去7日間にマージされたPR (21件)

### [散布図にズームとパンを追加（あとスクショもできるようになった）](https://github.com/digitaldemocracy2030/kouchou-ai/pull/404)

**作成者:** tokoroten  
**作成日:** 2025-04-30T13:08:13Z  
**変更:** +7 -3 (2ファイル)  
**マージ日:** 2025-04-30T13:47:07Z  
**内容:**

# 変更の概要
散布図をズームとパンで操作できるようにするために、Plotlyのコンフィグを変更した

副次的効果として、スクリーンショットボタンが付いた

# スクリーンショット

![dd2030-plotly](https://github.com/user-attachments/assets/a68e8d26-59dc-43da-a3be-77aa28cea80f)

# 変更の背景
範囲選択して拡大がめんどくさすぎた

# 関連Issue

#306 

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [E2Eテスト環境の依存関係インストール修正](https://github.com/digitaldemocracy2030/kouchou-ai/pull/394)

**作成者:** NISHIO Hirokazu+Devin  
**作成日:** 2025-04-29T13:56:39Z  
**変更:** +117 -44 (5ファイル)  
**マージ日:** 2025-04-29T16:51:01Z  
**内容:**

# E2Eテスト環境の依存関係インストール修正

## 概要
E2Eテスト環境のCI実行時に依存関係のインストールが失敗する問題を修正しました。

## 修正内容
- `npm ci` コマンドが必要とする `package-lock.json` ファイルを追加
- これにより、GitHub Actionsでの依存関係インストールが正常に実行できるようになります

## 参考
このPRはPR #390 の修正です。

リンク: https://app.devin.ai/sessions/fc39bd7faed64fc1974439a23934e541
依頼者: NISHIO Hirokazu (nishio.hirokazu@gmail.com)


**コメント:** なし

---

### [文脈埋め込み（エンベデッド）の処理をローカルで動かせるようにする](https://github.com/digitaldemocracy2030/kouchou-ai/pull/392)

**作成者:** tokoroten  
**作成日:** 2025-04-29T12:59:02Z  
**変更:** +103 -4 (12ファイル)  
**マージ日:** 2025-04-29T13:58:45Z  
**内容:**

# 変更の概要
- 埋め込み処理のためのSentenseTransformerを導入

# スクリーンショット
- 埋め込み処理をサーバ内で行う、というチェックボックスを作成しました
![image](https://github.com/user-attachments/assets/43339bad-79fd-410f-bb5e-49296e9ef627)

# 変更の背景
- 自治体職員が利用する場合、OpenAIのアカウント作成や、APIの利用料金で躊躇する可能性があるため、エンベデッド処理をSentenseTransformerを使ってローカル化することで、そのコストを抑制する

# 関連Issue
関連するIssueのリンクをこちらに記載してください

#385

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [基本的なE2Eテスト環境構築](https://github.com/digitaldemocracy2030/kouchou-ai/pull/390)

**作成者:** NISHIO Hirokazu+Devin  
**作成日:** 2025-04-29T12:07:02Z  
**変更:** +354 -0 (11ファイル)  
**マージ日:** 2025-04-29T13:48:13Z  
**内容:**

# 基本的なE2Eテスト環境構築

## 概要
issue #380 に基づき、Playwrightを使用した基本的なE2Eテスト環境を構築しました。

## 実装内容
1. プロジェクト全体で使用するためのPlaywrightセットアップ (`/test/e2e/`)
2. 管理者向けレポート作成ページの基本的なテストケース
3. GitHub Actionsでの自動実行設定（日次実行とラベルトリガー）
4. APIエンドポイントと認証のモック設定

## テスト方法
以下のコマンドでローカルでテストを実行できます：
```
cd test/e2e
npm install
npx playwright install
npm test
```

## 参考
このPRはissue #380 を解決します。

リンク: https://app.devin.ai/sessions/fc39bd7faed64fc1974439a23934e541
依頼者: NISHIO Hirokazu (nishio.hirokazu@gmail.com)


**コメント:** なし

---

### [用語統一: クラスタ→意見グループ、クラスタリング→意見グループ化](https://github.com/digitaldemocracy2030/kouchou-ai/pull/389)

**作成者:** nsk.smn+Devin  
**作成日:** 2025-04-29T07:17:50Z  
**変更:** +35 -35 (11ファイル)  
**マージ日:** 2025-04-29T07:46:45Z  
**内容:**

# 用語統一: クラスタ→意見グループ、クラスタリング→意見グループ化

## 変更内容
- clientとclient-adminフロントエンドコンポーネント内の「クラスタ」という用語を「意見グループ」に変更
- 「クラスタリング」という用語を「意見グループ化」に変更
- 変数名やクラス名は変更せず、表示テキストのみを変更

## 関連Issue
Closes #388

## 影響範囲
- ユーザー向け表示テキストのみの変更
- 機能的な変更はなし

## Link to Devin run
https://app.devin.ai/sessions/823bf4bf008344e68a5415f15c165404

## Requested by
nsk.smn@gmail.com


**コメント:** なし

---

### [Windows環境セットアップガイドの改善](https://github.com/digitaldemocracy2030/kouchou-ai/pull/387)

**作成者:** NISHIO Hirokazu+Devin  
**作成日:** 2025-04-29T06:29:09Z  
**変更:** +36 -5 (2ファイル)  
**マージ日:** 2025-04-29T12:13:09Z  
**内容:**

# Windows環境セットアップガイドの改善

## 変更内容

以下のフィードバックに基づいてWindows用のセットアップガイドを更新しました：

1. Dockerインストール後の再起動の必要性を明記
   - Dockerコマンドのパスが通るためには再起動が必要な場合がある点を追加

2. Docker Desktopの明示的な起動の必要性を強調
   - 自動起動設定をしていない場合は毎回手動で起動する必要がある点を追加

3. OpenAI APIキーの貼り付け方法に関する注意点を追加
   - コマンドプロンプトではCtrl+Vが機能しないため、右クリックでの貼り付け方法を案内

4. OpenAI APIキーの有効性チェック機能を追加
   - setup_win.batにAPIキーの形式チェック機能を実装
   - 不正な形式の場合に警告と確認を表示

## テスト

- setup_win.batの変更はWindows環境でのみ完全にテスト可能ですが、バッチファイルの構文は正しく更新されています
- ドキュメントの更新はユーザーフィードバックに基づいて明確に記述されています

Link to Devin run: https://app.devin.ai/sessions/28c147520d24426cad036b05ca8d9f1a
Requested by: NISHIO Hirokazu (nishio.hirokazu@gmail.com)


**コメント:** なし

---

### [ドキュメント: v2.0.0リリースに伴い、各プラットフォーム向けユーザーガイドを更新・追加](https://github.com/digitaldemocracy2030/kouchou-ai/pull/386)

**作成者:** NISHIO Hirokazu+Devin  
**作成日:** 2025-04-29T04:06:29Z  
**変更:** +334 -11 (11ファイル)  
**マージ日:** 2025-04-29T04:16:19Z  
**内容:**

# 概要
安定版v2.0.0リリースに伴い、ドキュメントを更新しました。

## 変更内容
1. Windows環境でのユーザーガイドを「Zipでダウンロードして」から「安定版リリースをダウンロードして」に変更
2. Mac環境向けのユーザーガイドを新規作成
3. Linux環境向けのユーザーガイドを新規作成
4. Mac/Linux用のセットアップスクリプト（`setup_mac.sh`、`setup_linux.sh`）を作成
5. Mac/Linux用の起動/停止スクリプト（`start_mac.sh`、`stop_mac.sh`、`start_linux.sh`、`stop_linux.sh`）を作成
6. READMEを更新し、ツール利用者（releaseからダウンロード）とOSS開発者（mainブランチをgit cloneする）の区別を明確化
7. CONTRIBUTING.mdに開発者向けの注意書きを追加

## 関連Issue
なし

## 確認事項
- [ ] 新規作成したMac/Linux向けガイドの内容が適切か
- [ ] 作成したスクリプトが各環境で正常に動作するか
- [ ] リンクが正しく機能するか
- [ ] 言語の一貫性が保たれているか

## Link to Devin run
https://app.devin.ai/sessions/224687d6737a40f7ac37bd2365910458

## CLA
I have read the CLA Document and I hereby sign the CLA


**コメント:** なし

---

### [プロンプトの編集バグを修正しclient-adminのリファクタリングを再適用する](https://github.com/digitaldemocracy2030/kouchou-ai/pull/384)

**作成者:** mtane0412  
**作成日:** 2025-04-27T13:48:16Z  
**変更:** +1494 -1110 (18ファイル)  
**マージ日:** 2025-04-28T01:46:21Z  
**内容:**

# 変更の概要
- AISettingsSection.tsx を変更し、内部で usePromptSettings を使わず、親から props として promptSettings を受け取るようにしました
- page.tsx を変更し、既存の promptSettings を AISettingsSection コンポーネントに渡すようにしました
- revertされていたリファクタリングを再適用

## 追加調査
クラスタ数やLLMモデルの変更は確認した。
Roo Code(Claude 3.7)による各コンポーネントで同様の問題が起きていないかの調査
- BasicInfoSection - 問題なし。すべての状態とハンドラーを props として受け取っています。
- CsvFileTab - useClusterSettings をインポートしていますが、実際には使用していません(型情報を使用)。props として clusterSettings を受け取っているので問題ありません。
- ClusterSettingsSection - 問題なし。すべての状態とハンドラーを props として受け取っています。
SpreadsheetTab - useClusterSettings をインポートしていますが、実際には使用していません(型情報を使用)。props として clusterSettings を受け取っているので問題ありません。
- WarningSection - 静的コンポーネントで、内部で状態を持っていません。
CommentColumnSelector - 問題なし。すべての状態とハンドラーを props として受け取っています

# スクリーンショット
## プロンプト変更の確認
![](https://i.gyazo.com/80af573fef515190e2ed8c6373657236.png)
各段階で更新文字列を確認した

## モデルの確認
![](https://i.gyazo.com/d69221924053a83235644daba60b64e0.png)
各段階でモデルが変更されていることを確認

# 変更の背景
- client-adminのリファクタリングを実施したところ、カスタムプロンプトが反映されていないバグが生じた(revertで対応)
- コンポーネント内で状態を持っていた

# 関連Issue
#351 #358 : client-adminのリファクタリング
#375 : カスタムプロンプトがレポートに反映されていないバグレポート
#377 : revert
#380 : E2Eテスト導入

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [add mtane0412 to maintainer](https://github.com/digitaldemocracy2030/kouchou-ai/pull/383)

**作成者:** nasuka  
**作成日:** 2025-04-26T06:54:41Z  
**変更:** +2 -1 (1ファイル)  
**マージ日:** 2025-04-26T06:54:58Z  
**内容:**

# 変更の概要
たねのぶさんをメンテナに追加

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [LLMの出力にStructured Outputによるjsonフォーマットの強制を可能にする](https://github.com/digitaldemocracy2030/kouchou-ai/pull/382)

**作成者:** tokoroten  
**作成日:** 2025-04-25T15:44:10Z  
**変更:** +442 -71 (6ファイル)  
**マージ日:** 2025-04-28T06:22:33Z  
**内容:**

# 変更の概要
- ChatGPTを呼び出す際に、jsonスキーマによる出力フォーマットを指定可能にする
- pydanticのBasemodelを継承した型による出力フォーマットの指定を可能にする

# 変更の背景
現在は、ChatGPTの生成の揺らぎによって、出力されるjsonのフォーマットが揺らぐという問題がある。そのため、structured outputを有効化して、出力フォーマットを固定化する。
https://platform.openai.com/docs/guides/structured-outputs

#352 で、LLMのプロンプトによって出力フォーマットを制御することを検討しているが、structured outputによって、出力フォーマットを明示的に指定したほうが効率的である。

# 関連Issue
#373
#296

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

# 現在の開発状況
- llm.py を単体実行して動作確認をしている、全体をテストしているわけではない
- 呼び出し元を改修できていない
- Azure版の動作確認ができていない


**コメント:** なし

---

### [Azure に client-static-build コンテナを追加](https://github.com/digitaldemocracy2030/kouchou-ai/pull/381)

**作成者:** shgtkshruch  
**作成日:** 2025-04-25T12:15:49Z  
**変更:** +102 -7 (7ファイル)  
**マージ日:** 2025-04-25T14:14:17Z  
**内容:**

# 変更の概要
- Azure 環境に #360 で実装した、client の static build 用のコンテナを追加しました
  - client-static-build にヘルスチェック用のエンドポイントを追加
  - .azure/templates 以下に client-static-build 用のファイルを追加
  - Makefile に Azure にコンテナを作成するコードを追加

# スクリーンショット
- 特になし

# 変更の背景
- 基本的には既存の Makefile のコードを踏襲して実装しました
- 手元で動作確認したこと
  - `make azure-setup-all` でのインフラ構築
  - `make azure-status` でのステータス確認
  - `make azure-logs-client-static-build` でのログ出力の確認
  - `make azure-restart-client-static-build` でのコンテナ再起動
  - `make azure-cleanup` でのインフラ削除

# 関連Issue
- fix: #220 

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [client-adminのリファクタリングをrevert](https://github.com/digitaldemocracy2030/kouchou-ai/pull/377)

**作成者:** nasuka  
**作成日:** 2025-04-25T08:51:21Z  
**変更:** +1110 -1485 (18ファイル)  
**マージ日:** 2025-04-25T08:59:44Z  
**内容:**

# 変更の概要
* 以下のPRのマージコミットをrevert
  * https://github.com/digitaldemocracy2030/kouchou-ai/pull/351
  * https://github.com/digitaldemocracy2030/kouchou-ai/pull/358

# 変更の背景
* （恐らく）直近のclient-adminのリファクタに伴って、レポート作成時に編集したプロンプトが反映されずデフォルトのプロンプトが使われていた
  * 自分のフロント力だとぱっと直せなさそうだったので一旦revertしています
  * revert後の内容で、プロンプトが反映されて正常にレポートが出力できることは確認しました

# 関連Issue
https://github.com/digitaldemocracy2030/kouchou-ai/issues/375

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [アルゴリズムのイシューテンプレートをアップデート](https://github.com/digitaldemocracy2030/kouchou-ai/pull/369)

**作成者:** nasuka  
**作成日:** 2025-04-24T14:44:18Z  
**変更:** +4 -0 (1ファイル)  
**マージ日:** 2025-04-24T14:49:47Z  
**内容:**

# 変更の概要
* アルゴリズムの実験結果をまとめる場所をテンプレートに追記

# 変更の背景
* アルゴリズムの実験結果をまとめる場所について、assignee がどこにまとめるべきか戸惑ってしまう課題があったのでテンプレートに追記

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [[実験] 埋め込みベクトルを用いた類似コメントの検知コード](https://github.com/digitaldemocracy2030/kouchou-ai/pull/368)

**作成者:** tokoroten  
**作成日:** 2025-04-24T09:28:01Z  
**変更:** +1701 -0 (7ファイル)  
**マージ日:** 2025-04-24T14:51:23Z  
**内容:**

# 変更の概要

- experimentalのフォルダを掘り、実験コードを格納するためのフォルダを作成
- SentenceTransformer を使って、パブリックコメントの埋め込みベクトルを計算し、重複を排除するための実験コードを作成
  - https://sbert.net/

- 処理をするための元データは以下から取得可能
  - https://w1740803485-clv347541.slack.com/archives/C08F7JZPD63/p1745221416748989?thread_ts=1745208882.923669&cid=C08F7JZPD63
  - https://github.com/digitaldemocracy2030/kouchou-ai/issues/280

## 処理の流れ
### 重複検知
- パブコメをSentenceTransformer 文脈埋め込みベクトルに変換
- 埋め込みベクトルのコサイン類似度を取得
- コサイン類似度が一定以上のものを抽出し、重複の可能性を示す

### クラスタリング
- パブコメをSentenceTransformer 文脈埋め込みベクトルに変換
- 埋め込みベクトルからクラスタリングを実施
- クラスタごとに、クラスタ中心を求め、クラスタ中心への距離に従ってソート
- 結果をExcelとして出力、いい感じに閲覧可能にする

# 出力例
## 重複検知
![image](https://github.com/user-attachments/assets/df4f5b61-51f8-4732-84be-fc3fa101ed43)

# 変更の背景

# 関連Issue

#345 
#346
#361

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [.github配下のテンプレートをアップデート](https://github.com/digitaldemocracy2030/kouchou-ai/pull/362)

**作成者:** nasuka  
**作成日:** 2025-04-23T06:14:16Z  
**変更:** +21 -1 (3ファイル)  
**マージ日:** 2025-04-23T06:16:18Z  
**内容:**

# 変更の概要
* アルゴリズム実験関連のテンプレートを追加
* ドキュメンテーションテンプレートのtypoを修正
* PR templateにスクリーンショットの欄を追記

# 変更の背景
* テンプレートが不足している/不備があったので修正

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [admin から static な HTML ファイルをダウンロードできるようにする](https://github.com/digitaldemocracy2030/kouchou-ai/pull/360)

**作成者:** shgtkshruch  
**作成日:** 2025-04-22T13:19:03Z  
**変更:** +2805 -15 (11ファイル)  
**マージ日:** 2025-04-24T06:37:30Z  
**内容:**

# 変更の概要
- admin から client を static build した成果物を zip でダウンロードできるようにしました

## screenshot

### admin のレポート一覧

「全レポートをエクスポート」ボタンを追加

![スクリーンショット 2025-04-22 21 49 57](https://github.com/user-attachments/assets/c29e996a-67bc-4992-91d3-0d26cc72bb88)

### ボタンクリック後

二重にエクスポート処理が走らないようにボタンを loading 状態にする

![スクリーンショット 2025-04-22 21 50 03](https://github.com/user-attachments/assets/14399212-0af2-4b62-8b8d-cc26c6953a6b)

### エクスポート成功時

トーストを表示して、ボタンを初期状態に戻す

![スクリーンショット 2025-04-22 21 51 17](https://github.com/user-attachments/assets/2414cb14-3eaf-47d0-a891-9067f65aec91)

# 変更の背景
- static build 用の client-static-build コンテナを追加しました
  - 技術的に検証したところ、client コンテナを再利用できそうでしたが、以下の理由からビルド用のコンテナを作る方針にしました
     - アプリを動作させるための環境とビルド用の環境が混在するので責務分離ができない
     - ビルド用のコンテナでは exec でコマンドを実行する必要があり、この機能を Web に公開している client コンテナで実行するのはセキュリティ的にリスクがある
     - ビルドは重い処理が走るので、client コンテナで実行するとアプリのホスティングのパフォーマンスに影響が出る可能性がある
  - ビルド用のコンテナでは、リクエストを待ち受けてビルドコマンドを実行する機能があれば良いので、express で軽量な実装にしました
    - hono でも実装してみたのですが、zip の stream を渡す処理が express の方が素直に書けたので express を選択しました
  - client-static-build コンテナでは client と同じ環境変数などの設定が必要なので、環境変数の設定漏れなどがないようにするために、Compose file の [Extensions](https://docs.docker.com/reference/compose-file/extension/) を利用して共通化しました

# やっていないこと

- Azure 環境への client-statc-build コンテナを追加
  - この PR の方針で良ければ後続の PR で対応予定です
- ビルドが長時間かかった場合の UX の検討
  - データ量が多くなってくるとビルドに時間がかかるので、同期的なダウンロードだと待ち時間が長くなると思います
  - 非同期処理にして、ダウンロードが終わったら通知するような設計もありそうですが、検討がもう少し必要なのと、この PR ではブラウザからの static export の検証を主目的にしているので、一旦はシンプルな設計にしています
- 別タブを開いたり複数ユーザーが多重実行した場合の制御
  - この機能が使われるようになって、必要性が出てきてから実装でも良いかなと個人的には思っています

# 関連Issue
- #220 

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [Solve issue #290 階層図のUI/UX改善](https://github.com/digitaldemocracy2030/kouchou-ai/pull/359)

**作成者:** masatosasano2  
**作成日:** 2025-04-22T13:01:59Z  
**変更:** +90 -24 (3ファイル)  
**マージ日:** 2025-04-23T10:23:55Z  
**内容:**

# 変更の概要
- 全体図、濃い意見グループ、階層図、全画面表示を行き来するときに階層図の表示階層を保持する
- パンくずリストの色を濃くして目立たせる
- 全画面終了のアイコンを戻るっぽいものから縮小っぽいものに変更 https://lucide.dev/icons/minimize-2
- 現在のクラスタのラベルを極力折り返さない（折り返しの文字数を15から幅いっぱいの50にする）

# 変更の背景
4/12 の meetup で意見の出た階層図の使いにくさを解消するための変更です。
検討事項や修正方針の詳細は下記のIssueをご確認ください。

# 関連Issue
https://github.com/digitaldemocracy2030/kouchou-ai/issues/290

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。
- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [client-admin/app/page.tsxのリファクタリング (関連: #336)](https://github.com/digitaldemocracy2030/kouchou-ai/pull/358)

**作成者:** mtane0412  
**作成日:** 2025-04-22T13:00:46Z  
**変更:** +112 -125 (1ファイル)  
**マージ日:** 2025-04-23T02:07:29Z  
**内容:**

# 変更の概要
- styleを直接記述している箇所をChakra UIのStyle propsに変更
- 不要なクリック防止イベントの廃棄( #336 で触った範囲 )
  - 「レポートを編集する」Dialogに関して必要な箇所をクリック防止イベントを残した
  - 「レポートを編集する」Dialog外をクリックした際は、Dialogを閉じるように変更した(下記に詳細)
- レポートのクリック範囲拡大用の記述をChakra UIの LinkBox に変更 ( #316)

「レポートを編集する」に関して、Dialog表示中にDialog内とDialog外両方(=全画面)をクリックするとレポートに遷移してしまうのを防ぐためにクリック防止を導入していた。
`<Dialog.Content>` に `onClick={e => e.stopPropagation()}` を記述するとDialog内の’クリックは防止されるがDialog外をクリックすると依然として遷移する問題が残った。
`<Dialog.Root>` に `closeOnInteractOutside` を true に設定し、そもそもDialog外のクリックでDialogを閉じるようにしたところ、遷移しなくなった。挙動としては自然なので一旦この方法にした。(詳しい人いたら修正してほしい。)

# 変更の背景
- #336 のフロントのコードレビューの追加PR

# 関連Issue
#316 クリック可能範囲を広げるPR
#336 フロントのコードレビュー

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [add ruff setting on .vscode/settings.json](https://github.com/digitaldemocracy2030/kouchou-ai/pull/354)

**作成者:** nishio  
**作成日:** 2025-04-21T17:55:52Z  
**変更:** +9 -1 (1ファイル)  
**マージ日:** 2025-04-25T06:15:42Z  
**内容:**

# 変更の背景/概要
- Biomeの設定は書かれているがRuffの設定は書かれていない、書いたほうがいい？

# 関連Issue
関連するIssueのリンクをこちらに記載してください

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [[REFACTOR] langchainの依存を削除する](https://github.com/digitaldemocracy2030/kouchou-ai/pull/353)

**作成者:** nishio  
**作成日:** 2025-04-21T17:52:06Z  
**変更:** +8 -13 (3ファイル)  
**マージ日:** 2025-04-25T07:08:32Z  
**内容:**

## 変更内容

- `server/broadlistening/pipeline/services/llm.py`: langchainのOpenAIEmbeddingsを直接OpenAI SDKの呼び出しに置き換え
- `server/broadlistening/pipeline/utils.py`: langchainのメッセージスキーマを直接OpenAI SDKの形式に置き換え
- `server/pyproject.toml`: langchain関連の依存関係を削除

## 関連Issue

Closes #58

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [OpenAI API Rate Limit対策の実装](https://github.com/digitaldemocracy2030/kouchou-ai/pull/331)

**作成者:** nsk.smn+Devin  
**作成日:** 2025-04-18T06:00:08Z  
**変更:** +395 -26 (2ファイル)  
**マージ日:** 2025-04-24T14:46:25Z  
**内容:**

# OpenAI API Rate Limit対策の実装

## 概要
Issue #295 に記載されている問題を解決するため、OpenAI APIのRate Limit (429) エラーに対して指数バックオフ付きリトライ処理を実装しました。

## 変更内容
- tenacityライブラリを使用して、OpenAI APIのRate Limit (429) エラーに対する指数バックオフ付きリトライ処理を実装
- `request_to_openai`と`request_to_azure_chatcompletion`関数に対してリトライデコレータを追加
- エラー発生時のログ出力を追加
- リトライ設定：
  - 最大3回のリトライ
  - 指数バックオフ（初期2秒、最大60秒）
  - RateLimitErrorとAPIStatusErrorに対してリトライ

## テスト
- 実装後の動作確認を行いました

Link to Devin run: https://app.devin.ai/sessions/67c2a06784d74e068af3a03c787f2394
Requested by: nsk.smn@gmail.com


**コメント:** なし

---

### 過去7日間に作成されたPR (6件)

### [Devinとのコラボレーションについてのドキュメントを追加](https://github.com/digitaldemocracy2030/kouchou-ai/pull/399)

**作成者:** shingo-ohki  
**作成日:** 2025-04-30T04:18:45Z  
**変更:** +140 -62 (2ファイル)  
**内容:**

# 変更の概要
- ドキュメントに Devin についての記述を追加

ChatGPT が提案してくれたものをベースに、実態に合わせて修正してみました。
Issue 自体があくまで仮説なため、あくまで「ないよりはあったほうがいい」というくらいに考えていますが、
これが適切かどうか自信はないので、たたき台と思ってガンガンコメントいただければと思います。

# 変更の背景
Devin との協働に戸惑う開発者もいるだろうと考えられるため、何らかの軽減措置があるとよさそう

# 関連Issue
#398 

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [Issue #396: 管理画面の基本e2eテストを実装](https://github.com/digitaldemocracy2030/kouchou-ai/pull/397)

**作成者:** NISHIO Hirokazu+Devin  
**作成日:** 2025-04-30T01:58:00Z  
**変更:** +657 -13 (2ファイル)  
**内容:**

# 管理画面の基本e2eテスト実装

Issue #396 に基づいて、管理画面の基本的なエンドツーエンドテストを実装しました。このテストでは、以下の基本的なワークフローをテストします：

1. 管理画面へのアクセスとログイン（Basic認証）
2. レポート作成ページへの移動
3. 基本情報の入力
4. CSVファイルのアップロード
5. レポート作成の実行と成功確認

## 変更内容
- `test/e2e/tests/admin/create-report.spec.ts` ファイルを更新し、テストを実装
- 既存のページオブジェクトとユーティリティを活用

## テスト方法
テストを実行するには以下のコマンドを使用します：
```
cd test/e2e
npm test
```

Link to Devin run: https://app.devin.ai/sessions/1883f9aaaede4ddab11a25bbbde4d8bc
Requested by: NISHIO Hirokazu (nishio.hirokazu@gmail.com)


**コメント:** なし

---

### [extractionのプロンプトを改善](https://github.com/digitaldemocracy2030/kouchou-ai/pull/378)

**作成者:** nasuka  
**作成日:** 2025-04-25T09:30:59Z  
**変更:** +7 -5 (1ファイル)  
**内容:**

# 変更の概要
* extractionのデフォルトプロンプトを改善した

# 変更の背景
* 元のプロンプトでは、稀にAI導入に関する文言がextractionの結果に紛れ込むケースがあった
  *  `人工知能に関する公開協議を実施した状況を想定しています。`  という文言が入っており、恐らくこちらが悪さをしていたと思われる。
    *   上記の点含めて、全体的に内容を修正している
    * 元プロンプト: https://github.com/digitaldemocracy2030/kouchou-ai/blob/fe0f56c7a6d7eb82aa61ff124e8c4ceca66633b8/client-admin/app/create/extractionPrompt.ts#L1-L47


# スクリーンショット
変更前後のプロンプトで出力されたレポートの散布図を記載。
* beforeではクラスタ（およびargument）にAI導入という文言が入るケースがあったが、なくなっている
* beforeと比べてafterでは抽出件数が多くなっている
  * 1143件 -> 1375件
  * ただ、クラスタタイトルの傾向は大きくは変わらない
  * 抽出件数など、挙動がこれまでのデフォルトプロンプトと変わる部分はあるものの基本的には改良されているはず

before
![image](https://github.com/user-attachments/assets/4803a4f6-8274-401b-ab69-7af8c4b1eb6e)

after
![image](https://github.com/user-attachments/assets/6fca2f48-bbab-4cce-92ce-ee86be466b0f)



# 関連Issue
https://github.com/digitaldemocracy2030/kouchou-ai/issues/371

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [[Fix] プロンプト編集が反映されない問題を修正 (#375)](https://github.com/digitaldemocracy2030/kouchou-ai/pull/376)

**作成者:** nsk.smn+Devin  
**作成日:** 2025-04-25T08:27:10Z  
**変更:** +16 -13 (4ファイル)  
**内容:**

# プロンプト編集が反映されない問題を修正

## 概要
イシュー #375 を解決するために、レポート作成時に編集したプロンプトが反映されない問題を修正しました。

## 原因
クライアント側とサーバー側でプロンプト設定のフィールド名に不一致がありました：
- クライアント側: `initialLabelling`, `mergeLabelling` (キャメルケース)
- サーバー側: `initial_labelling`, `merge_labelling` (スネークケース)

この不一致により、サーバー側が編集されたプロンプトを正しく認識できず、デフォルトのプロンプトが使用されていました。

## 修正内容
クライアント側のフィールド名をサーバー側のフィールド名に合わせて修正しました。

## テスト方法
1. レポート作成画面でプロンプトを編集する
2. レポートを作成する
3. 編集したプロンプトが反映されていることを確認する

## 関連イシュー
Fixes #375

Link to Devin run: https://app.devin.ai/sessions/c54c5df0da8948268c72c1f95adfd5b4
Requested by: nsk.smn@gmail.com



**コメント:** なし

---

### [fix: プロンプトからAI特有の文脈を削除 #371](https://github.com/digitaldemocracy2030/kouchou-ai/pull/372)

**作成者:** nsk.smn+Devin  
**作成日:** 2025-04-25T06:22:46Z  
**変更:** +16 -15 (2ファイル)  
**内容:**

# プロンプトのAIバイアス問題を修正

## 変更内容
- プロンプト内のAI特有の例示を、より一般的なトピック（都市計画、公共サービス、地域安全など）の例に置き換えました
- extractionPromptから「人工知能に関する公開協議」の文脈を削除しました
- mergeLabellingPromptの出力例を「AI技術の導入〜」から「交通アクセスの改善〜」に変更しました

## 関連イシュー
Closes #371

## テスト方法
これらの変更により、分析結果に「AI技術の導入」などの文言が不適切に含まれなくなることを期待しています。実際の効果を検証するには、修正後のプロンプトで広聴AIシステムを実行して、出力結果を確認する必要があります。

Link to Devin run: https://app.devin.ai/sessions/5e3a450628d94a99bb470ecb5220ad5a


**コメント:** なし

---

### [Windows 環境で Docker を使わずに手動でセットアップできるようにするためのスクリプトおよび手順](https://github.com/digitaldemocracy2030/kouchou-ai/pull/363)

**作成者:** take365  
**作成日:** 2025-04-23T09:55:11Z  
**変更:** +127 -2 (3ファイル)  
**内容:**

# 変更の概要
- Windows 環境で Docker を使わずに手動でセットアップできるようにするためのスクリプトおよび手順を追加しました。
- `.env` 設定、仮想環境の準備、依存ライブラリのインストール、実行用の補助スクリプトなどを含みます。

# スクリーンショット
- UIの変更はありません。

# 変更の背景
- Issue #254 の調査を進める中で、Windows 環境での実行手段として「生環境構築」も検証しました。
- 開発時には WSL2 や Docker を立ち上げることが比較的重いため、軽量な起動ができる選択肢として「生環境での実行」も許容していただければと思います（どちらかというと私自身の開発効率向上の観点からの提案です、他に使う人もいなそうなら私だけマージして使ってますので、却下でも大丈夫です）。
- 今後も Docker や WSL2 による環境構築の整備は継続される見込みのため、これは補助的な手段として捉えています。

# 関連Issue
- https://github.com/digitaldemocracy2030/kouchou-ai/issues/254

# CLAへの同意
- [x] コントリビューターライセンス契約（CLA）に同意します。

**コメント:** なし

---

### 過去7日間に更新されたPR（作成・マージを除く）(1件)

### [LLM出力形式の揺らぎによる抽出エラーの修正](https://github.com/digitaldemocracy2030/kouchou-ai/pull/352)

**作成者:** nishio  
**作成日:** 2025-04-21T17:21:42Z  
**変更:** +84 -13 (4ファイル)  
**内容:**

# LLM出力形式の揺らぎによる抽出エラーの修正

## 問題点
LLMからの応答が、プロンプトで期待した形式（例：文字列リスト `[str]`）と異なる形式（例：オブジェクトリスト `[{意見:"str", トピック:"str"}]`）で返ってくることがあり、データ抽出が失敗したり、抽出される意見数が少なくなったりする問題を修正しました。

## 修正内容
1. **プロンプトの改善**：
   - 出力形式をより明確に指定するようプロンプトを更新
   - 期待される出力形式の例をより詳細に提示

2. **構造化出力の活用**：
   - is_json=Trueオプションを使用して、JSON形式の応答を強制

3. **エラーハンドリングの強化**：
   - 異なる形式の応答にも対応できるよう、パース処理を改善
   - オブジェクトリスト形式からの文字列抽出ロジックを追加
  

# 関連Issue
- #296

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---


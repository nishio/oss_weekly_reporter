# GitHub レポート: digitaldemocracy2030/kouchou-ai

期間: 2025-04-11 から 2025-04-18 まで

## Issues

### 過去7日間に完了されたissue (10件)

### [[FEATURE]第一階層の意見グループ数の上限を増やす](https://github.com/digitaldemocracy2030/kouchou-ai/issues/330)

**作成者:** nasuka  
**作成日:** 2025-04-18T05:59:54Z  
**内容:**

# 背景
* 現在、全体図などの散布図において意見グループの個数上限は20となっている
  * ラベルが重なってしまう問題があったため上限を20にしていたが、この問題は回避策のPR（ https://github.com/digitaldemocracy2030/kouchou-ai/pull/329 ）が出されている

# 提案内容
* グループ数の上限を40に増やす
* グループのカラーバリエーションも20 -> 40に増やす

**コメント:** なし

---

### [[BUG]Azure Storage連携をしている場合にパブコメモードのCSVファイルがDLできなくなる](https://github.com/digitaldemocracy2030/kouchou-ai/issues/325)

**作成者:** nasuka  
**作成日:** 2025-04-17T16:26:03Z  
**内容:**

### 概要
Azure Storage連携をしている際に、スクショ部分のCSVファイルがDLできない

![Image](https://github.com/user-attachments/assets/893a2ac4-d4f4-4ae5-8cc1-e77c8c68ccbe)

ストレージ連携をしている場合は、ストレージに出力ファイル等をアップロードをした後に容量節約のために不要なファイルを削除しているが、その際に当該のCSVファイルも削除されてしまっているためDLできなくなっている。


**コメント:** なし

---

### [[FEATURE] 作成日時がUTCで出力される](https://github.com/digitaldemocracy2030/kouchou-ai/issues/317)

**作成者:** mtane0412  
**作成日:** 2025-04-17T02:03:03Z  
**内容:**

# 背景
- macOSでdockerを使用してセットアップした環境では、レポートの作成日時がUTCで表示されている
- 非技術者がいつデータを作成したのかという点で混乱しそう

# 提案内容
- タイムゾーン設定を追加する
- デフォルトタイムゾーンを日本時間にする

**コメント:** なし

---

### [[DOCUMENT]docker-compose → docker compose](https://github.com/digitaldemocracy2030/kouchou-ai/issues/298)

**作成者:** nishio  
**作成日:** 2025-04-13T01:41:53Z  
**内容:**

https://w1740803485-clv347541.slack.com/archives/C08F7JZPD63/p1744505244553429

NISHIO Hirokazu
>「README.md記載の「docker-compose up」ではコマンド未発見エラー：「docker compose up」とハイフンなしにして解決」
>(解決策) READMEのコマンドを docker compose up (ハイフンなし) に修正する。

これはどっちが正しいんだろ


Pin
docker-compose が v1、docker compose が v2 で、前者が廃止予定で後者に徐々に置き換わっていっています
そのため docker-compose コマンドが入っていない環境が増えてきていて、v2 出てからもう結構経つので、基本は v2 に寄せていく方針が良さそうです
逆に docker-compose があって docker compose がない状況になるのは、v2 以前に構築した docker 環境をアップデートせずに使っている場合くらいかなと思いますが、そういう人は自力で読み替えられそうかなと:blob-thinking:（おそらく docker 歴5年〜の人なので）

**コメント:** なし

---

### [[BUG]階層図を全画面表示にすると一番右上の要約文が「全画面終了」ボタンの後ろに隠れてしまう](https://github.com/digitaldemocracy2030/kouchou-ai/issues/278)

**作成者:** masatosasano2  
**作成日:** 2025-04-11T01:26:15Z  
**内容:**

### 概要

全画面表示の「全画面終了」ボタンの後ろに要素の要約文が一部隠れてしまい、読めないことがある。

### 再現手順

1. レポート画面を開く
2. 「階層図」chartに切り替える
3. 「全画面表示」ボタンを押す
4. 一番右上のパネルにマウスカーソルを重ねる

発生条件：正確な条件は未調査。他のchat（全体図、濃い意見グループ）でもノードの配置によっては発生しそう。

### 期待する動作

要約文が隠れないで欲しいです。

修正されるにあたって以下の点が満たされてほしいのですが、具体的な修正案はありません。
・画面右上に要素が密集していても問題ないようにする
　（なので、おそらく「要約文を要素の左上に出す」ではNG）
・「全画面終了」ボタンが隠れてしまい見つけられないことを防ぐ
　（なので、おそらく「要約文を最前面に出す」ではNG）

### スクリーンショット・ログ

![Image](https://github.com/user-attachments/assets/d0fbad20-e890-4901-b39f-1ebc3aaae5d2)


**コメント:** なし

---

### [[FEATURE]管理画面でCSVをアップロードしたとき、エラーで落ちても進捗状況を自動更新する](https://github.com/digitaldemocracy2030/kouchou-ai/issues/277)

**作成者:** masatosasano2  
**作成日:** 2025-04-11T01:04:01Z  
**内容:**

# 背景
正常に動作するとstep1(抽出)からstep8(可視化)まで自動更新され、その後レポートのURLが表示されるが、
エラーで落ちると進捗が更新されず、ページを再読込して初めてエラーになったことが可視化される。

実際に発生したケース：OpenAPIのクレジットが足りず初手の抽出で落ちた。
正確な発生条件：未調査

# 提案内容
`client-admin/app/page.tsx` で `useReportProgressPoll` の結果が "completed" の場合にページがリロードされているが、 "error" の場合の処理も必要そう。

**コメント:** なし

---

### [[FEATURE]adminのレポート一覧画面にも作成日時を追加する](https://github.com/digitaldemocracy2030/kouchou-ai/issues/268)

**作成者:** nasuka  
**作成日:** 2025-04-09T05:09:39Z  
**内容:**

# 背景
* client側ではレポート一覧画面で作成日時が表示されるようになったが、adminでは表示がされない
  * client側のPR: https://github.com/digitaldemocracy2030/kouchou-ai/pull/245


# 提案内容
* client側と同様、admin側でも一覧画面で各レポートの作成日時を表示する

**コメント:** なし

---

### [初期設定時のentrypoint.shエラー](https://github.com/digitaldemocracy2030/kouchou-ai/issues/243)

**作成者:** nasuka  
**作成日:** 2025-04-06T11:02:11Z  
**内容:**

## バグの内容
初期設定時にentrypoint.shエラーが出たため、ChatGPTに解決策を聞いたものとなります。
http://localhost:3000/　http://localhost:4000/のページは見れるようになりました。
環境がWindows10で、PowerShell 5.xです。

【エラー内容①】
client-1 exited with code 0
/entrypoint.sh: line 5: syntax error: unexpected "fi" (expecting "then")

●エラーの意味：
client（レポート表示画面）の起動時に、entrypoint.sh という起動スクリプトの中に文法ミスがあります

正確には：
if 文が書いてあるけど、その中に then がない
そのまま fi（if の終わり）に到達して、エラーになってる

●修正案１（？）
if [ "$NODE_ENV" = "production" ]; then
  npm run start
else
  npm run dev
fi

●修正案２（？）
#!/bin/sh
# 起動時に全て削除した上でbuildしなおす
if [ -d ".next" ]; then
  rm -rf .next
fi  

# build時にAPIサーバーを参照するため、APIサーバーの起動を待ってからbuildを行う
npm run build
exec npm run start

●修正案３（？）
Windowsメモ帳が改行コードをCRLF（\r\n）にしてしまうせいで、Docker内で「: not found」や syntax error: unexpected "fi" が出る。
✅ 対処方法（メモ帳ユーザーでもOK）
PowerShellで改行コードをLFに変換する（推奨）
以下を PowerShell で kouchou-ai フォルダ内で実行：
＜PowerShell＞
手順１（PowerShell 7.x対応）
cd ~\kouchou-ai
(Get-Content .\client\entrypoint.sh) -join "`n" | Set-Content -NoByteOrderMark -Encoding utf8 .\client\entrypoint.sh

手順１修正版コマンド（PowerShell 5.x対応）
(Get-Content .\client\entrypoint.sh) -join "`n" | Set-Content -Encoding UTF8 .\client\entrypoint.sh
手順２
docker-compose down
docker-compose up --build






【エラー内容②】
client-1 | ./entrypoint.sh: line 1: ﻿#!/bin/sh: not found
この「﻿」は見えないBOM文字。Windowsのメモ帳で保存した .sh ファイルはUTF-8 with BOMになりやすい。
手順１：entrypoint.sh の最初の行のBOMを完全に除去する
●修正案②ー１（PowerShell 7.x対応）
Get-Content .\client\entrypoint.sh | Out-File -Encoding ASCII -NoNewline .\client\entrypoint.sh
●修正案②ー２（PowerShell 7.x対応）
Get-Content .\client\entrypoint.sh | Set-Content -Encoding UTF8 -NoByteOrderMark .\client\entrypoint.sh
●修正案②ー３（PowerShell 5.x対応）
[System.IO.File]::WriteAllLines('.\client\entrypoint.sh', [System.IO.File]::ReadAllLines('.\client\entrypoint.sh'), (New-Object System.Text.UTF8Encoding($false)))


手順２：フルリセットして再起動
docker-compose down --volumes --remove-orphans
docker-compose build --no-cache
docker-compose up


---
こちらのイシューはGoogle Form経由で投稿されたものです

**コメント:** なし

---

### [[FEATURE]Azureのデプロイ更新作業をMakefileにまとめる](https://github.com/digitaldemocracy2030/kouchou-ai/issues/214)

**作成者:** nishio  
**作成日:** 2025-04-01T08:22:16Z  
**内容:**

# 背景
作業が複雑なため

## chat log
nishio
最新版でAzureにデプロイされているものを更新しようとしたのですが、色々トラブって結局できませんでした。 makeでazure-login azure-build azure-acr-login-auto azure-push make azure-config-update make azure-fix-client-adminまでやったのですが見た目が変わらなくて、何がいけなかったのかなぁと思っています。
truego
上記だと、clien-admin コンテナは新しいもので起動しますが、client と api のコンテナは古いまま（イメージは新しくなったけどコンテナは古いもので起動したまま）になりそうですね。 azure-fix-client-admin の処理の中の以下の部分（古いイメージのコンテナを停止して、新しく push されたイメージでコンテナを起動する）と同様のことを client, api コンテナでもやる必要がありそうな気がしました。
```
az containerapp update --name client-admin --resource-group $(AZURE_RESOURCE_GROUP) --min-replicas 0 && \ echo '>>> 再度スケールアップ...' && \ sleep 5 && \ az containerapp update --name client-admin --resource-group $(AZURE_RESOURCE_GROUP) --min-replicas 1"
```

nishio
apiサーバを再起動したらレポートが全部消えたので無事コンテナの更新ができたようです:爆笑: Spreadsheetを読む機能が増えてたのでソースコードの更新は成功、問題はレポートの復元だけ


# 提案内容
Makefileにターゲットとしてまとめる


**コメント:** なし

---

### [[FEATURE]50件の小さいデータで試した場合に濃いクラスタ抽出で見た目が変わらない問題の解決](https://github.com/digitaldemocracy2030/kouchou-ai/issues/96)

**作成者:** nishio  
**作成日:** 2025-03-19T02:41:35Z  
**内容:**

# 背景
50件の小さいデータで試した場合に濃いクラスタ抽出で見た目が変わらないことに混乱する


# 提案内容

案1:

>濃いクラスタ抽出で見た目が変わらないのはデータが少なすぎて実行されてないからか？そういう時にはボタンを非表示にしたいかも。クリックして変わらないのは混乱させる

この方法が良いかはわからない

**コメント:** なし

---

### 過去7日間に作成されたissue (26件)

### [[FEATURE] レポートのタイトルを変更できるようにする](https://github.com/digitaldemocracy2030/kouchou-ai/issues/328)

**作成者:** mtane0412  
**作成日:** 2025-04-18T05:21:40Z  
**内容:**

# 背景
現在最初に設定したタイトルの変更は管理画面からはできない(という認識)。

クラスタ設定を間違えたり、Rate Limitが発生して不完全なレポートでも出力例として残したい場合などに、タイトルを変更してわかりやすく管理したい。

# 提案内容
レポート一のオプションボタンからタイトルを編集できるようにする

![](https://i.gyazo.com/45b10370a28fd77f8ed520ec8bc7f702.png)

**コメント:** なし

---

### [[FEATURE]Scatterにおいてラベルの表示/非表示を選択できるようにする](https://github.com/digitaldemocracy2030/kouchou-ai/issues/327)

**作成者:** nasuka  
**作成日:** 2025-04-18T05:09:15Z  
**内容:**

# 背景
* 意見グループ数が増えるとラベルが重なって見にくくなるという問題がある
* この問題があるため、意見グループを一定以上に増やすことが難しい


# 提案内容
* ラベルの表示/非表示を設定できるようにする
  * 表示の場合は全ラベルを表示し、非表示の場合はどのラベルも表示しない

**コメント:** なし

---

### [[FEATURE]ファクトチェックロジックの実験](https://github.com/digitaldemocracy2030/kouchou-ai/issues/324)

**作成者:** masatosasano2  
**作成日:** 2025-04-17T14:09:02Z  
**内容:**

# 背景
各サービスでファクトチェックが必要とされている。
ファクトチェック処理は共通化できるので、本Issueはその共通処理を実験するためのIssueとする。
処理のコードをどこに置くべきかはidobata側のリポジトリの統一後に検討する。

# 関連Issue

1. https://github.com/digitaldemocracy2030/kouchou-ai/issues/170
2. https://github.com/digitaldemocracy2030/idobata-analyst/issues/97
3. https://github.com/digitaldemocracy2030/idobata-discourse-agent/issues/51

# 関連Issue1から抜粋

<img width="600" alt="Image" src="https://github.com/user-attachments/assets/5968bb66-9070-4a84-b0cb-170205f319e5" />

# 提案内容

- 実装方針：どこかで議論されていたとおり怪しいものは弾かずOKにして、明確に偽情報と判断した場合のみ弾く。
- 準備：偽情報を含みそうな適当なデータセットを用意し、人力で正解データを作る。
- 実験概要：以下のコストや精度を比較する。他のアプローチがあれば随時試す。
    - 既存のファクトチェックサービスで偽と判定された場合のみNGとする
    - いくつかの信用できる情報源を指定し、そこから取得できる事実から偽と判定された場合のみNGとする
    - 単純なWeb検索の結果から偽と判定された場合のみNGとする
    - DeepResearch的な仕組を自作し、それに偽と判定された場合のみNGとする
    - 既存のDeepResearch系のサービスで偽と判定された場合のみNGとする

**コメント:** なし

---

### [[FEATURE] レポートの多言語対応](https://github.com/digitaldemocracy2030/kouchou-ai/issues/323)

**作成者:** mtane0412  
**作成日:** 2025-04-17T11:57:43Z  
**内容:**

# 背景
Steamのレビューデータで遊んでいるときに、コメントは多言語でLLMも読めるが、最後のレポートでも元言語で表示されるために多言語混在状態となり、人間が読みづらい問題があるかなと思いました。
実運用場面では、異なる言語を話す住民に対して同一の調査を実施できるようになるというストーリーがありそうだなと思いました。


# 提案内容
Pol.isのようなレポート出力時の翻訳機能をつける
出力言語を選択できるようにする

**コメント:** なし

---

### [[FEATURE] 意見を抽出できなかったときのエラーハンドリング](https://github.com/digitaldemocracy2030/kouchou-ai/issues/318)

**作成者:** mtane0412  
**作成日:** 2025-04-17T02:28:08Z  
**内容:**

# 背景
XのポストやSteamのレビューなどで試しているときに、extractionの段階で大量の `ERROR:root:Task <Future at 0xffff7d57f470 state=finished raised RuntimeError> failed with error: JSON list not found` が出ます。
おそらくコメントの中から意見を抽出できないことが多いと推測。(違ったら教えて下さい。)

実運用ではまとまった意見のデータが使われると思いますが、レポート作成者が「抽出段階でよくわからないエラーが出ている」という体験がありそうかなと思いました。

#315 が実装された場合に向けてログのノイズを減少させる。

# 提案内容
意見が抽出できなかった場合、元コメントと併記して意見が抽出できなかったことをログ出力する。

**コメント:** なし

---

### [[FEATURE]エラーログをファイルに出力する](https://github.com/digitaldemocracy2030/kouchou-ai/issues/315)

**作成者:** nasuka  
**作成日:** 2025-04-16T12:06:28Z  
**内容:**

# 背景
* 自治体の担当者などが広聴AIを動かしてエラーがおきた際に、どのようなエラーが起きているのかを広聴AI開発サイドに伝えてもらいたいが、担当者側でエラーログを確認するのが難しい


# 提案内容
* エラーログをファイルに出力するようにする
  * エラーが起きた場合は、ファイルに書き出された内容を伝えてもらう or ファイルの内容をそのまま教えてもらう

広聴AIでsentryを用意し、エラーログをそちらに集約する案も出たが、機微情報が含まれることが懸念される可能性がある。上述した方式であれば、機微情報は担当者側で削除した上でエラーログを連携してもらうことが可能。

**コメント:** なし

---

### [[FEATURE] LLMが出力した結果の手動修正機能がほしい](https://github.com/digitaldemocracy2030/kouchou-ai/issues/310)

**作成者:** nasuka  
**作成日:** 2025-04-15T05:38:53Z  
**内容:**

# 背景
* LLMが出力したクラスタ名や説明、argumentが適切でない場合がある
  * e.g.
    * 公開するのに不適切な単語や表現がクラスタ名に含まれている
    * 他のクラスタと同一の内容がクラスタ名に含まれている
* このようなケースにおいては、LLMのアウトプットを見た後に人間が手動で文言を修正したい

# 提案内容
LLMが出力したテキスト（クラスタタイトル・説明・概要・argument）について、手動で編集する画面をadminに設け、レポートに編集内容を反映する


(admin)
* 上記の編集画面を設ける
  * 編集後のデータを編集用のendpointに送る

(api)
* 編集用のendpointを実装する
  * リクエストで受け取ったデータを各種中間ファイル（args.csv等）に保存
  * hierarchical_aggregation.pyを再度実行し、更新後のデータでhierarchical_result.jsonを保存する

そもそも全要素を編集できるようにするかというのは議論の余地がある。やるとしても、まずはクラスタ名のみを対象にするなど、部分的に始めていくのが良さそう。
また、透明性担保のために編集履歴を残すようにするかも議論の余地がある。

**コメント:** なし

---

### [[FEATURE] HTML フォーム入力による広聴 AI システムの簡易デプロイ機能](https://github.com/digitaldemocracy2030/kouchou-ai/issues/308)

**作成者:** shingo-ohki  
**作成日:** 2025-04-15T00:11:32Z  
**内容:**

# 背景

先日のハッカソンに参加して、改めて広聴 AI の導入について技術的なハードルの高さとその導入サポートにに課題がありそうだと感じました。

#300 によって Windows 環境でのセットアップは大きく改善されますが、
- PC へのソフトウェアインストール自体が難しい場合もある
- Azure 環境の構築に make コマンドが必要（WSL2 などのセットアップ含む）

といった点が、導入の障壁として残っている（そこまで現段階で対応するかどうかは議論の余地あり）と考えています。

# 提案内容

## 概要
HTML フォーム + Azure Functions（または Azure に限らず同等のことが実現できる環境） のセットを提供することで、ユーザーがフォームに必要な情報（Azure 認証情報、OpenAI API キーなど）を入力するだけで、自動的に自身の Azure 環境上に広聴 AI の環境を構築できる仕組みを提供します。

## 想定構成

![Image](https://github.com/user-attachments/assets/cab67945-f74a-49d6-8650-88249f766d57)

- static form(HTML フォーム)
  - Azure Storage の Static Web Hosting に設置
  - 必要な認証情報や設定項目を入力
- Azure Functions
  - 入力された情報をもとに、Azure 上に必要なリソース（Container Apps 等）を作成・デプロイ

※フォームと Functions はセットで提供され、ユーザー操作は基本的にフォーム入力のみで完結

## 構築される環境
- 広聴 AI のシステム（Azure Container Apps による server, client, client-admin 構成）
- 利用料金はユーザーの Azure アカウントにて発生
- Static HTML と Azure Functions はプロジェクト側または第三者がホスティング（マネージドサービスかつ無料枠の想定、要検証）

# 利点
- PC 操作に不慣れな方でも数ステップで導入が可能
- コマンド操作・ローカル環境構築が不要
- ユーザーごとの環境依存によるトラブル発生率の低下
- 実証実験・テスト環境など、導入コストを下げたい場面での展開が容易
- サポート負担の軽減

# 懸念点・検討課題
- そもそもこのニーズはあるか？今やるべきか？
- フォーム経由で機微情報（Azure 認証情報、OpenAI API キーなど）を扱うこと
- Azure アカウントの事前取得が必要
- Static HTML + Azure Functions をプロジェクトとしてホスティングできるか？

**コメント:** なし

---

### [[FEATURE]「全体図」「濃い意見グループ」のUI/UX改善](https://github.com/digitaldemocracy2030/kouchou-ai/issues/306)

**作成者:** masatosasano2  
**作成日:** 2025-04-13T11:20:06Z  
**内容:**

# 背景

操作しててたまたま以下に気づいたが、見ただけでは分からない。
・範囲指定（ドラッグ）すると拡大できること
・拡大した状態から元の倍率に戻すにはダブルクリックすること

濃い意見グループで上がってきているクラスタが第一階層？のクラスタのどれに属すのかがわからない。

# 提案内容

ズームについて
- ヒントアイコンで操作方法のヒントを表示する
- ズームイン/アウトの操作ボタンを用意する（ドラッグでパンできないので、上下左右の移動ボタンも必要？）
- 表示モードや全画面に切り替えたときに表示がリセットされないように Issue #290 を参考に状態保持を実装する

濃い意見グループについて
- ラベルか色で表現する？

**コメント:** なし

---

### [[FEATURE]CSVアップロード時にタイトルや説明文を自動で埋めてほしい](https://github.com/digitaldemocracy2030/kouchou-ai/issues/305)

**作成者:** masatosasano2  
**作成日:** 2025-04-13T07:45:30Z  
**内容:**

# 背景
入力の一手間を減らしたい
入力漏れでエラーにならないでほしい

# 提案内容
- タイトルと説明文を optional にする
- 空の場合にCSVの内容から自動生成する　※説明文は必須でないかも

**コメント:** なし

---

### [[FEATURE]CSVアップロード時にコメント列を自動で特定してほしい](https://github.com/digitaldemocracy2030/kouchou-ai/issues/304)

**作成者:** masatosasano2  
**作成日:** 2025-04-13T06:59:09Z  
**内容:**

# 背景
コメント列の指定の一手間を減らしたい

# 提案内容
- コメントの列名が「コメント」「comment」「意見」「要望」「投稿」などであったらデフォルトでその列を指定してほしい
- 候補の列名はハードコードで一定カバーし、マッチしなかったらLLMに一番それっぽいのを選んでほしい
- 列が1つしかなかったらそれをコメント列と判定してほしい
- 数値/日付型でない列が1つしかなかったらそれをコメント列と判定してほしい

**コメント:** なし

---

### [[FEATURE]CSVアップロード時にデフォルトでクラスタ数が設定されてほしい](https://github.com/digitaldemocracy2030/kouchou-ai/issues/303)

**作成者:** masatosasano2  
**作成日:** 2025-04-13T06:58:07Z  
**内容:**

# 背景
クラスタ数の設定の一手間を減らしたい

# 提案内容
- クラスタ数について「この設定にする」を押さないと推奨設定通りにならず、そのことが詳細画面を開かないとわかりにくい
- クラスタ数のデフォルト値より小さい件数のCSVを取り込んだ時、先に進もうとするとアラートが出てくれるのは嬉しいが、それなら最初から推奨設定をセットして欲しい


**コメント:** なし

---

### [[FEATURE]「公開」ボタンを押した時の効果を分かりやすくする](https://github.com/digitaldemocracy2030/kouchou-ai/issues/302)

**作成者:** masatosasano2  
**作成日:** 2025-04-13T06:51:12Z  
**内容:**

# 背景
キャプションが「公開」の状態のボタンを押すと非公開になり、「非公開」の状態のボタンを押すと公開になる。
キャプションの意味は現在の状態であってボタンを押した時に発生するアクションではないので間違ってはいないのだが、
client-adminでもclientでも大抵のボタンのキャプションは押した時のアクションに近いので、やや紛らわしい。

# 提案内容
- 案1：マウスオーバー中のみ「非公開にする」「公開にする」などのヒントを表示する
- 案2：マウスオーバー中のみ逆の状態の見た目にする
- 案3：ボタンからスイッチに変える
- 案4：ボタンからチェックボックスに変える　＊この場合、「非公開にする」チェックの方が自然かも

**コメント:** なし

---

### [[FEATURE]Windowsユーザの利用環境構築](https://github.com/digitaldemocracy2030/kouchou-ai/issues/300)

**作成者:** nishio  
**作成日:** 2025-04-13T03:36:08Z  
**内容:**

# 背景

Windowsユーザーがkouchou-aiを利用する際、現在は複数のセットアップ方法（WSL2+Docker、Docker単体、生環境）があり、開発者ではなくただ使いたいユーザーにとって環境構築が難しい状況です。特に環境変数の設定やパスの問題が発生しやすく、環境ごとの違いが多くてトラブルシューティングも困難です。

# 提案内容

Docker-outside-of-Docker（DooD）方式を使用して、Windowsユーザー向けのセットアップを簡素化します。

## ユーザストーリー
- Docker Desktopをインストール
- zipでrepoをダウンロード
- OpenAI APIキーを取得して$5くらいチャージする
- setup_win.batを実行
- ブラウザでアクセス可能になる

## 実装方法
setup_win.batがDocker環境内にUbuntuコンテナを作成し、その後の作業は全てDocker内で実行します。具体的には：

1. OpenAI APIキーの入力プロンプトを表示
2. 環境変数を自動設定
3. docker composeでサービスを起動

## メリット
- WSL2の複雑な設定が不要
- 環境変数の問題を回避
- Windowsの環境の違いによる問題を解消
- コマンドラインの知識が不要

## 技術的詳細
- ホストのDockerソケットをマウント（/var/run/docker.sock）
- 必要なポート（3000, 4000, 8000）をマッピング
- 環境変数を適切に設定

これにより、Windowsユーザーでも簡単にkouchou-aiを利用できるようになります。


**コメント:** なし

---

### [[FEATURE]CSVダウンロード時の文字化け (Windows)](https://github.com/digitaldemocracy2030/kouchou-ai/issues/297)

**作成者:** nishio  
**作成日:** 2025-04-13T01:36:52Z  
**内容:**

# 背景
Admin DashboardからレポートデータをCSV形式でダウンロードすると、WindowsのExcelなどで開いた際に文字化けが発生する。

「Dashboard reportsのCSVファイルをダウンロードしたら、Windowsでは文字化けする」


# 提案内容
(解決策) CSVファイルを生成する際に、文字コードをUTF-8 BOM (Byte Order Mark) 付きで出力するなどのオプションを選択可能にする。



**コメント:** なし

---

### [[FEATURE]LLM出力形式の揺らぎによる抽出エラー](https://github.com/digitaldemocracy2030/kouchou-ai/issues/296)

**作成者:** nishio  
**作成日:** 2025-04-13T01:22:24Z  
**内容:**

# 背景
LLMからの応答が、プロンプトで期待したJSON形式（例: 文字列リスト [str]）と異なる形式（例: オブジェクトリスト [{“意見”:str, “トピック”:str}]）で返ってくることがあり、データ抽出が失敗したり、抽出される意見数が少なくなったりする。

「Rate limitかと思われた抽出データが少ない事例の一つにおいて、JSON List[str]ではなく[{“意見”:str, “トピック”:str}]が返っていたせい(nishio)」
「これのせいで抽出されるデータが減るのは困るし、それに多分ユーザは気づけなくて「こんなもんか〜」となりそう」

# 解決策

プロンプトを改善し、出力形式の指示をより明確かつ堅牢にする。

LLMからの応答をパースする際に、期待する形式以外もある程度許容する、またはエラーハンドリングを強化して異常を検知できるようにする。

**コメント:** なし

---

### [OpenAI API Rate Limit関連の問題](https://github.com/digitaldemocracy2030/kouchou-ai/issues/295)

**作成者:** nishio  
**作成日:** 2025-04-13T01:19:38Z  
**内容:**

## 課題

広聴AIのレポート生成プロセスにおいて、OpenAI API の Rate Limit (利用制限) に起因する問題が複数発生しています。

1.  **Rate Limit によるエラー頻発 (特にTier1ユーザー):**
    *   OpenAI API を使い始めたばかりのユーザー (Usage tier が Tier 0 や Tier 1) は、分間あたりのリクエスト数 (RPM) やトークン数 (TPM) の制限が非常に厳しいです。
    *   そのため、数百件程度のコメントデータであっても、レポート生成中に RateLimitError (HTTPステータスコード 429) が頻発し、処理が遅延したり失敗したりします。
    > 「OpenAI始めたばかりだとTier1問題」
    > 「300コメント程度でもrate limitが出る」
    > (大量のRateLimitErrorログ引用: `ERROR:root:Task ... failed with error: Error code: 429 - {'error': {'message': 'Rate limit reached for gpt-4o-mini ...` )

2.  **Rate Limit エラー発生時の不完全なレポート生成:**
    *   現在の実装では、Rate Limit エラーが発生しても、処理は停止せず続行されます。
    *   リトライが上限に達した場合、該当部分のデータ取得（例: クラスタラベルの生成）がスキップされ、結果として一部の情報が欠落した「不完全なレポート」がエラー表示なく生成されてしまうことがあります。
    *   ユーザーは、Rate Limit が原因であることや、レポートが不完全であることに気づきにくい状態です。
    > 「エラーでラベル名が取得できませんでしたが複数現れた」
    > 「今回のケースでは、ラベル名のみ生成に失敗していた」
    > 「rate limit errorが出るもののうごいているので、処理は正常にされたと思っていましたが、どうやらリトライされず一部エラーになったまま処理が終了されちゃったみたいです」
    > 「中途半端に抽出されたレポートができるのは不適切なので、rate limitの時にエラーとしてスルーしないようにする必要がある(nishio)」

## 解決策案

**1. Rate Limit エラー頻発への対策:**

*   **指数バックオフ付きリトライ処理の実装:** API呼び出し部分で RateLimitError (429) を検知した場合、待機時間を指数関数的に増やしながら、複数回（上限を設定して）API呼び出しを再試行する処理を実装します。
*   **ドキュメントでの周知:** README などに以下の情報を記載します。
    *   OpenAI API の Rate Limit の存在と Tier システムについて。
    *   自分のアカウントの Tier と Limit を確認する方法（OpenAI Platform の設定画面へのリンク）。
    *   Tier を上げるための条件（例: 一定額の支払いと利用期間）と公式ドキュメントへのリンク。「Rate limits - OpenAI API」「RateLimitError | OpenAI Help Center」
*   **(検討) 代替APIへの対応:** OpenRouter など、Rate Limit が比較的緩い、または管理しやすい API サービスへの対応を検討します。「OpenRouter APIにするのも候補の一つ。」
*   **(検討) 意図的な待機時間の挿入:** API リクエスト間に短い sleep を入れることで、瞬間的なリクエスト集中を緩和します。

**2. 不完全なレポート生成の防止:**

*   **エラーハンドリングの強化:** Rate Limit エラーが発生し、上記のリトライ処理を行っても成功しない場合は、**処理をスキップせずにレポート生成プロセス全体を明確なエラーとして中断・失敗させる**ように修正します。これにより、ユーザーは問題発生を確実に認識でき、不完全なデータが出力されることを防ぎます。
    *   リトライ回数には上限を設定し、無限ループ（や無限課金）を防ぎます。「無限リトライはしないので(元データがおかしい時に無限にお金を使う)3回くらい試して先に進んでるかと(nishio)」

**コメント:** なし

---

### [[FEATURE]ラベルが多い時の重なりの問題](https://github.com/digitaldemocracy2030/kouchou-ai/issues/294)

**作成者:** nishio  
**作成日:** 2025-04-13T00:59:47Z  
**内容:**

## 課題

広聴AIのレポート画面に表示されるプロットグラフにおいて、分析によって生成されたクラスタ（意見グループ）の数が多い場合に、各クラスタを示すラベルが互いに重なり合ってしまい、判読が困難になるという問題があります。

特に、自治体での利用など、詳細な分析のためにクラスタを細かく分ける傾向がある場合に、この見にくさが顕著になります。
> 「自治体的には、クラスタを細かく分ける方向の議論が強い。」
> 「UIの観点で、プロットグラフがそれに対応していけるとよさそう。」
> 「ラベルは重なって見にくくならないようにできるとか」

現状のままでは、せっかく詳細に分類された意見グループの内容を、グラフ上で直感的に把握することが難しくなっています。

## 解決策案

グラフ上でのラベルの重なりを軽減し、視認性を向上させるために、以下のいずれか、または組み合わせによる改善策を検討します。

*   **ラベル表示の選択的ON/OFF:** ユーザーが表示したいラベルを選択したり、一定数以上のラベルはデフォルトで非表示にする機能を追加する。
    > 「ラベル全部は表示しない設定」
*   **重なり回避アルゴリズムの導入:** ラベルの位置を自動的に調整し、重なりを最小限に抑えるアルゴリズムを実装する。
*   **インタラクティブなラベル操作:** ユーザーがグラフ上でラベルをドラッグ＆ドロップして任意の位置に移動できるようにする。
*   **ズームレベルに応じた表示制御:** グラフの拡大率に応じて、表示するラベルの数を調整する（例: 縮小時は主要なラベルのみ表示）。

**コメント:** なし

---

### [[FEATURE]レポート表示画面上で、使用したプロンプトを直接編集可能にする](https://github.com/digitaldemocracy2030/kouchou-ai/issues/293)

**作成者:** nishio  
**作成日:** 2025-04-13T00:58:21Z  
**内容:**

## 課題

現在、生成された広聴AIレポートの内容（特に要約文言など）に不満があり修正したい場合、以下の手順を踏む必要があり、手間と時間がかかります。

1.  Admin Dashboard画面に戻る。
2.  対象のレポートを探して複製する。
3.  複製したレポートの設定（主にプロンプト）を調整する。
4.  再度レポート生成を実行する。

> 「ユーザーとして、広聴AIレポート画面で出力された成果物に不満があり作り直したい場合に、手間と時間がかかる（Admin Dashboard画面に戻り、レポートを複製し、文言調整を行う。1度の修正ごとにレポートが1枚のレポートを生成する必要がある）」

特に、プロンプトの微調整を繰り返して最適な出力結果を得たい場合、この往復作業は大きな負担となります。

## 提案

レポート表示画面（例: `http://localhost:5173/reports/{report_id}`）に、そのレポート生成に使用されたプロンプトを表示し、**直接編集および更新（再生成）** できる機能を追加します。

**具体的な流れ:**

1.  レポート表示画面の下部など（例: 現状「分析手順」が表示されている箇所）に、編集可能なプロンプト入力欄を表示する。
2.  ユーザー（※後述の権限者のみ）がプロンプトを編集する。
3.  「更新して再生成」のようなボタンをクリックすると、編集後のプロンプトを使用してレポートの再生成処理が開始される。
4.  レポート表示画面が更新され、新しい結果が表示される。

これにより、Admin Dashboardに戻ることなく、試行錯誤しながらレポートの質を効率的に向上させることが可能になります。（参考: TTTCTurboのレポート画面における同様の機能）
> 「TOBE：利用したプロンプトを編集、更新できる（参考TTTCTurboのレポート画面）」

## 考慮事項

*   **権限管理:** 広聴AIでは、レポートの作成権限を持つユーザーと閲覧権限のみを持つユーザーが存在する想定です。プロンプトの編集・再生成機能は、**レポート作成権限を持つユーザーのみ**が利用できるように制限する必要があります。閲覧権限のみのユーザーには、プロンプトの表示は行うかもしれませんが、編集・再生成ボタンは表示しない、または無効化するなどの制御が必要です。
*   **コスト:** レポートの再生成にもLLM APIのコストが発生するため、実行前に確認を促すなどのUI上の配慮が必要になる可能性があります。
*   **UI/UX:** プロンプト編集エリアのデザイン、再生成中のステータス表示方法などを検討する必要があります。


**コメント:** なし

---

### [[DOCUMENT]OpenAI APIの課金設定に関する混乱](https://github.com/digitaldemocracy2030/kouchou-ai/issues/292)

**作成者:** nishio  
**作成日:** 2025-04-13T00:52:56Z  
**内容:**

# 現在の問題点
非エンジニアにとって、OpenAI APIキーの取得と課金設定（クレジット購入）が必要であることが分かりにくく、ChatGPT Plusと混同しやすい。設定不備によりQuota超過エラー (429) が発生する。

「OpenAIの課金の設定してなかった」
「Error code: 429 - 'You exceeded your current quota, please check your plan and billing details.'」
「非エンジニアの場合、環境を設定した際にOpenAI APIに課金するというステップがわからない(たねのぶ)」
「OpenAIに課金=ChatGPT Plusだと思う人もいる」

# 提案内容
<!-- どのようなリファクタリングを提案するのか、具体的に説明してください -->
(解決策) READMEに、OpenAI APIキーの取得手順と、ChatGPT Plusとは別にAPI利用のためのクレジット購入（支払い方法登録）が必要であることを明記する。Quota超過エラーの意味と対処法も説明する。


**コメント:** なし

---

### [[DOCUMENT].envファイルの不可視問題 (Mac Finder)](https://github.com/digitaldemocracy2030/kouchou-ai/issues/291)

**作成者:** nishio  
**作成日:** 2025-04-13T00:51:49Z  
**内容:**

# 現在の問題点
MacのFinderでは .env ファイルがデフォルトで非表示のため、cp example.env .env を実行した後、ファイルを見つけられないユーザーがいる。

「.env見つからない」
「Sampleからコピーしてきたとき、それをVScodeで開こうとするときに見つからない」
「隠しファイルをfinderで開こうとしていた」


# 提案内容

READMEで、FinderではなくVSCodeなどのエディタでプロジェクトフォルダを開いて .env ファイルを編集することを推奨する。「実はFinder経由でどうこうするよりVSCodeでフォルダを開いてしまうほうが良かった」


**コメント:** なし

---

### [[FEATURE]階層図のUI/UX改善](https://github.com/digitaldemocracy2030/kouchou-ai/issues/290)

**作成者:** nishio  
**作成日:** 2025-04-13T00:49:58Z  
**内容:**

# 背景
階層図の操作性や情報表示に改善の余地がある (クリック操作の分かりにくさ、表示リセット、親子関係不明瞭、命名規則、戻るボタン欠如)。

from 4/12 meetup
>「階層図のギミックを確認、初見でクリックによって深層に移動できることがわからなかった。」
「全体図、濃い意見グループ、階層図を行き来するときに階層図の表示がリセットされなくなるとうれしい。」
「濃い意見グループで上がってきているクラスタが第一階層？のクラスタのどれに属すのかがわかるとうれしい。」
「階層図の第一階層？第二階層の名前が決まっていると嬉しい。」
「「１階層前に戻る」ボタンがあると助かります」

# 提案内容
(解決策) クリック操作のガイド表示、表示状態の保持、親子関係の明示（例: パンくずリスト）、階層命名規則の明確化、戻るボタンの追加など、UIを改善する。


**コメント:** なし

---

### [[FEATURE]exe形式での配布によるインストール簡略化](https://github.com/digitaldemocracy2030/kouchou-ai/issues/289)

**作成者:** nishio  
**作成日:** 2025-04-13T00:24:58Z  
**内容:**

# 背景
<!-- なぜその機能が必要なのか、何が改善されるのか具体的に記入してください -->
現状の広聴AIはDockerとGitの知識・インストールが前提となっており、特にITスキルやセキュリティ制限のある自治体ユーザーにとっては導入のハードルが高い。

>「Dockerのインストールが認められてない（情シス部門の理解が必要）」「自治体関係者の中でのアーリーアダプターたちが試す際に、最初の①リポジトリをクローン」段階で既にかなり大きなハードルになっている。」

# 提案内容
<!-- 実装案やデザイン案があれば記入してください -->

(解決策案) アプリケーションを単一の実行ファイル（.exe形式）にパッケージ化し、DockerやGitのインストール、コマンドライン操作を不要にすることを検討する。

>「exe化は難しいだろうか？(たねのぶ)」。

これにより、ダブルクリック等で簡単に起動でき、非エンジニアやセキュリティ制限のある環境でも利用しやすくなる可能性がある。ただし、技術的な実現可能性や配布ファイルサイズなどの課題も考慮する必要がある。


(nishioコメント) DockerやGitを「インストールできるが難しい」のケースには有効かも。「Dockerのインストールが認められてない」の場合、広聴AI.exeが作られたところでそれのインストールが認められないのではという気がする。

**コメント:** なし

---

### [[FEATURE]zipでのリリース](https://github.com/digitaldemocracy2030/kouchou-ai/issues/288)

**作成者:** nishio  
**作成日:** 2025-04-13T00:14:59Z  
**内容:**

# 背景
Docker/Gitのインストール障壁 (特に自治体ユーザー)
セキュリティポリシーやITスキル不足により、DockerやGitのインストール自体が大きなハードルとなっている。
「リポジトリ」などのIT専門用語が、非エンジニアのユーザーにとって理解しにくい。

>「自治体関係者の中でのアーリーアダプターたちが試す際に、最初の①リポジトリをクローン」段階で既にかなり大きなハードルになっている。」
「Dockerのインストール、Gitのインストールという部分で既にわけがわからなくなっている。」
>「リポジトリ」概念を避けて行政に納品する際は、zip圧縮などをしたりします。
> 「非エンジニアユーザー向けに、GitをインストールせずにZIPダウンロードで運用のほうがよい？(たねのぶ)」

# 解決策

zipでリリースすればgit cloneの部分の解説は必要なくなる


**コメント:** なし

---

### [[DOCUMENT]Windows向けのセットアップ手順](https://github.com/digitaldemocracy2030/kouchou-ai/issues/287)

**作成者:** nishio  
**作成日:** 2025-04-13T00:02:52Z  
**内容:**

# 現在の問題点
<!-- 現在のコードの何が問題なのか、どのような技術的負債があるかを説明してください -->

## 課題

現在の `README.md` は主にUNIX系（Linux, macOS）環境を前提としており、Windowsユーザーが広聴AIをセットアップする際に特有の課題に直面することが多いです。

*   **必須ツールのインストールと設定:** Docker DesktopやGit for Windowsのインストール、特に環境変数Pathの設定 (`'git' は、内部コマンドまたは外部コマンド...`) やWSL連携で躓く可能性がある。
*   **改行コードの問題:** クローン時に適切に対応しないと、シェルスクリプト (`entrypoint.sh`) 実行時にエラーが発生する。
*   **コマンドの違い:** `cp` コマンドなど、コマンドプロンプトとPowerShellでの違いに戸惑う可能性がある。
*   **隠しファイル:** `.env` ファイルがデフォルトで非表示のため、作成・編集時に混乱が生じやすい。
*   **Docker関連のエラー:** `npm ci` エラー、ポート競合 (`port is already allocated`)、証明書エラーなど、Windows環境固有または頻出する可能性のあるエラーへの対処法が不明確。

これらの問題により、特に非エンジニアやITスキルに不安のあるWindowsユーザーにとって、導入のハードルが高くなっています。「WindowsユーザーはDocker Desktopのダウンロードからはじまる」「GithubのREADMEは現在UNIX系前提?」「'git' は、内部コマンドまたは外部コマンド...」「パスを通すという困難な作業」「entrypoint.shの5行目でエラー。改行コードの関係」「.env見つからない」「Powershellでないとないかも。cmdではない」

## 提案

Windowsユーザー向けの専用セットアップガイドを `README.md` に追記、または別ドキュメントとして作成する。

**含めるべき内容:**

1.  **必要なソフトウェア:**
    *   Docker Desktop (インストール方法、wingetコマンド例、注意点: セキュリティポリシー、WSL/ログインエラー)
    *   Git for Windows (インストール方法、wingetコマンド例、**Path設定の重要性**、確認方法)
    *   (推奨) テキストエディタ (VSCodeなど)
2.  **セットアップ手順:**
    *   リポジトリのクローン (**`--config core.autocrlf=false`** オプションの明記)
    *   `.env` ファイルの作成 (Windowsコマンド: `copy` / `cp`、**隠しファイル問題**とVSCodeでの編集推奨)
    *   アプリケーションの起動 (**`docker compose up`** コマンドの明記、初回ビルド時間について)
3.  **よくある問題と対処法 (Windows向け):**
    *   `git` コマンドが見つからない → Path設定の確認
    *   `entrypoint.sh` エラー → 改行コード問題の確認と再クローン
    *   `npm ci` エラー → (現状考えられる原因や再試行)
    *   証明書エラー → セキュリティソフトの確認
    *   ポート競合エラー → 他コンテナ停止 or ポート変更
    *   `.env` ファイルが見つからない → 隠しファイル設定 or VSCode利用
    *   コマンドの違い (`cp` vs `copy`)
4.  **トラブルシューティングTips:**
    *   エラーメッセージをLLMに質問するなどの自助努力の方法提示

これにより、Windowsユーザーがスムーズにセットアップを完了できるよう支援し、利用者の裾野を広げることを目指します。

# 仮原稿
## はじめに
このドキュメントは、Windows環境で広聴AIのセットアップを行うユーザー向けの手順と注意点をまとめたものです。現在の公式READMEは主にUNIX系（Linux, macOS）環境を前提としているため、Windows特有の考慮事項があります。

## 必要なソフトウェア
セットアップには以下のソフトウェアが必要です。事前にインストールしてください。

1.  **Docker Desktop:**
    *   公式サイトからダウンロードしてインストールします。
    *   `winget install -e --id Docker.DockerDesktop` コマンドでもインストール可能です。
    *   インストール後、Docker Desktopを起動し、必要な初期設定（WSL連携など）を完了させてください。
    *   **注意:** 自治体PCなどでは、セキュリティポリシーによりインストールが許可されていない場合があります。情報システム部門にご確認ください。
    *   **注意:** Googleアカウントでのログイン時やWSLアップデート時にエラーが発生することが報告されています。エラーメッセージに従って対処するか、IT管理者に相談してください。「Docker、Googleアカウントにてログイン時にエラー。」「wsl update failed: update failed: updating wsl: exit code: 1...」

2.  **Git for Windows:**
    *   公式サイトからインストーラーをダウンロードしてインストールします。「Git for Windows Portable」ではなく、通常のインストーラー版を使用してください。
    *   `winget install -e --id Git.Git` コマンドでもインストール可能です。
    *   **重要:** インストール中に「Adjusting your PATH environment」の項目で、「Git from the command line and also from 3rd-party software」を選択することを推奨します。これにより、コマンドプロンプトやPowerShellから `git` コマンドが利用可能になります。
    *   **パス設定確認:** インストール後、コマンドプロンプトまたはPowerShellを開き、`git --version` を実行してバージョン情報が表示されればOKです。表示されない場合（「'git' は、内部コマンドまたは外部コマンド...として認識されていません。」エラー）、環境変数のPathにGitの実行ファイルパス（例: `C:\Program Files\Git\cmd`）を手動で追加する必要があります。「パスを通すという困難な作業」 - 不明な場合はChatGPT等で「Windows 環境変数 パス 通し方」などで検索・質問してください。

3.  **(推奨) テキストエディタ:**
    *   VSCodeなどのテキストエディタがあると、設定ファイルの編集に便利です。

## セットアップ手順

1.  **リポジトリのクローン (改行コード問題対策):**
    *   コマンドプロンプトまたはPowerShellを開き、作業したいディレクトリに移動します。
    *   以下のコマンドを実行して、リポジトリをクローンします。`--config core.autocrlf=false` オプションは、WindowsとLinux/macOS間の改行コードの違いによるエラー (`entrypoint.sh` 関連など) を防ぐために重要です。
        ```bash
        git clone --config core.autocrlf=false https://github.com/digitaldemocracy2030/kouchou-ai.git
        ```
    *   クローンした `kouchou-ai` ディレクトリに移動します。
        ```bash
        cd kouchou-ai
        ```

2.  **環境設定ファイルの作成:**
    *   `example.env` ファイルをコピーして `.env` ファイルを作成します。PowerShellでは以下のコマンドで実行できます。
        ```powershell
        cp example.env .env
        ```
        (コマンドプロンプトの場合は `copy example.env .env`)
    *   **注意:** `.env` は隠しファイル属性が付くことがあります。Windowsのエクスプローラーで表示されない場合は、「表示」タブ -> 「隠しファイル」にチェックを入れるか、VSCodeなどのエディタで `kouchou-ai` フォルダを開いて `.env` ファイルを編集してください。「.env見つからない」「隠しファイルをfinderで開こうとしていた」
    *   `.env` ファイルを開き、OpenAI APIキーなどの必要な設定値を記述します。

3.  **アプリケーションの起動:**
    *   Docker Desktopが起動していることを確認します。
    *   `kouchou-ai` ディレクトリ内で、以下のコマンドを実行します。**ハイフンなしの `docker compose up` を使用してください。**
        ```bash
        docker compose up
        ```
    *   初回起動時は、Dockerイメージのダウンロードとビルドに時間がかかります（数分～十数分程度）。「Docker imageがない状態でdocker compose upすると500s以上かかる」
    *   ビルドと起動が正常に完了すると、ログの最後に `Application startup complete.` のようなメッセージが表示され、Webブラウザで `http://localhost:3000` (Admin Dashboard) と `http://localhost:5173` (レポート画面) にアクセスできるようになります。

## よくある問題と対処法

*   **`git` コマンドが見つからない:**
    *   Git for Windowsのインストール時にパス設定が適切に行われなかった可能性があります。上記「必要なソフトウェア」のGitの項目を確認し、環境変数Pathを修正してください。
*   **`entrypoint.sh` 関連のエラー:**
    *   改行コードの問題である可能性が高いです。上記「リポジトリのクローン」の手順に従い、`--config core.autocrlf=false` オプション付きでクローンし直してください。
*   **`docker compose up` 中の `npm ci` エラー:**
    *   `[client-admin builder ... ] RUN npm ci` でエラーが発生する場合があります。(ログ参照) 根本的な解決策はログに記載されていませんが、ネットワーク環境やDockerのリソース割り当てなどが影響している可能性があります。時間をおいて再試行するか、Docker Desktopの設定を見直してください。
*   **`docker compose up` 中の証明書エラー (`uv` など):**
    *   会社のセキュリティソフトなどがDocker内の通信をブロックしている可能性があります。「自治体のセキュリティによってuvのインストール時に証明書エラーがおきた」一時的にセキュリティソフトを無効にするか、Docker関連の通信を許可する設定を行ってください。
*   **`Bind for 0.0.0.0:3000 failed: port is already allocated` エラー:**
    *   ポート3000が他のアプリケーション（他のDockerコンテナ等）によって既に使用されています。「原因：3000ポートをすでに使っているdocker containerが立ち上がっていた」他のアプリケーションを停止するか、`.env` ファイルで `APP_PORT` を別の番号（例: `3001`）に変更してください。
*   **`.env` ファイルが見つからない/編集できない:**
    *   隠しファイルになっている可能性があります。上記「環境設定ファイルの作成」の注意点を確認してください。VSCodeでフォルダを開くのが確実です。
*   **コマンドプロンプトで `cp` コマンドが使えない:**
    *   `cp` はPowerShellのコマンドです。コマンドプロンプトでは `copy` を使用してください。もしくはPowerShellを起動して作業してください。「Powershellでないとないかも。cmdではない」

## トラブルシューティングTips
*   エラーが発生した場合、表示されたエラーメッセージ全体をコピーし、ChatGPTなどのLLMに貼り付けて「このエラーの原因と解決策を教えてください」と質問すると、具体的な解決策が見つかることがあります。「エラーが出たら内容張り付けて「エラーでた助けて」といえばほぼほぼ解決もしてくれます。」


**コメント:** なし

---

### [Windows環境でのセットアップの困難さ低減](https://github.com/digitaldemocracy2030/kouchou-ai/issues/286)

**作成者:** nishio  
**作成日:** 2025-04-12T23:58:34Z  
**内容:**

READMEがUNIX系前提であり、WindowsユーザーはDocker/Gitのインストール、パス設定、改行コード問題などで躓きやすい。

from 4/12 meetup
>「WindowsユーザーはDocker Desktopのダウンロードからはじまる」
「GithubのREADMEは現在UNIX系前提?」
「Git for Windowsのダウンロード」
「'git' は、内部コマンドまたは外部コマンド、操作可能なプログラムまたはバッチ ファイルとして認識されていません。」
「パスを通すという困難な作業」
「entrypoint.shの5行目でエラー。改行コードの関係」

(解決策)

Windows向けのセットアップ手順（Docker, Gitインストール、パス設定含む）をREADMEに詳細に追記する。

改行コード問題を回避するため、リポジトリに .gitattributes ファイルを設定する。「これは.gitattributesで解決可能？(たねのぶ)」「可能です」

クローン時に git clone --config core.autocrlf=false ... を実行するよう案内する。

**コメント:** なし

---

### 過去7日間に更新されたissue（作成・クローズを除く）(13件)

### [[BUG] 静的ファイルがGithub Pagesでうまく表示されない件](https://github.com/digitaldemocracy2030/kouchou-ai/issues/274)

**作成者:** keisuke-a  
**作成日:** 2025-04-10T06:52:19Z  
**内容:**

### 概要

静的ファイルをoutして、その中身をgithub pagesで公開すると、out/index.html自体は表示はされるが、画像要素がなかったりリンク先（個別ページ）が404になるなど、うまく表示されない。（参照が絶対パスになってることによる？）


**コメント:** なし

---

### [（アルゴリズム検証） 広聴AIで出力したクラスタのタイトルが抽象的になる問題の解決](https://github.com/digitaldemocracy2030/kouchou-ai/issues/269)

**作成者:** nasuka  
**作成日:** 2025-04-09T06:22:31Z  
**内容:**

# 背景
広聴AIで出力した第一階層のクラスタタイトルが、TTTCのタイトルと比べて具体性に欠けるという声がある。
 
衆院選のデータセットでクラスタタイトルを出力した例を以下に記載する。クラスタ数はどちらも15で設定している。
本来はクラスタに属するデータ点との整合性なども含めて議論するのが理想だが、こちらではクラスタの抽象度についてのみ議論する。

### TTTCの出力結果
レポートのURL: https://news.ntv.co.jp/static/shugiinsenkyo2024/closed-1027/index.html

選挙結果への関心と不安
立憲民主党の支持増加と自民党への批判
過半数割れの可能性と連立政権の模索
投票率と市民参加の重要性
候補者の当選とその影響
選挙特番のエンタメ化
国民民主党と立憲民主党の議席増加への注目
議員の落選に対する反応
石破氏の責任問題
政権交代の可能性
地域別支持動向
和歌山2区の選挙結果
選挙結果の誤報や虚偽情報への懸念
れいわ新選組の躍進と支持拡大への関心
出口調査結果への関心と懐疑


### 広聴AIの出力結果

選挙結果と政治倫理に対する多様な反応と期待
地域別選挙動向と多様な反応
選挙に対する多様な関心と報道の影響
選挙参加と投票率に関する多様な視点と期待
選挙における政党の躍進と略称問題に対する多様な反応
衆院選結果に対する多様な反応と政治的期待
選挙における政党批判と有権者の多様な視点
選挙報道とスポーツ中継の視聴体験とメディアの役割
選挙結果の信頼性と世襲政治に対する多様な反応
日本の政治再編と選挙結果の影響
石破政権の持続性と自民党の未来に対する懸念と期待
日本の政治情勢における政党支持の変動とその影響
衆院選後の政治的再編と連立政権の行方
れいわ新選組の議席増加に対する多様な反応と期待
選挙における政権交代と地域政党の影響に関する多様な視点


感覚的だが、TTTCの出力結果が具体的な行動・現象や固有名詞（個人名・政党名等）がクラスタ名に含まれる傾向がある一方で、広聴AIの方は抽象性の高いタイトルがついているケースが多い。
一概にどちらが悪いといえるものはないが、実用性を考えるとTTTC程度の抽象度で記載されている方が有用な場合がある。

なお、o3-miniでも評価したが、同様の評価が記載されている。
https://chatgpt.com/share/67f60d38-43b4-800f-a20f-3836dbfa4518

![Image](https://github.com/user-attachments/assets/00a6bc92-5a48-4237-8da8-72be1dfbc1e5)

このような差分が生まれる要因として、以下が想定される。

* クラスタリングアルゴリズムの違い
  * 広聴AIではk-meansで第二階層のクラスタを形成した後にクラスタをマージして第一階層を形成するが、TTTCではspectral clusteringでクラスタを形成する
* クラスタリング時に用いる埋め込みの次元の違い
    * 広聴AIではUMAP後の2次元でクラスタリングを行っているが、TTTCでは元のembeddingでクラスタリングを行っている
      * 二次元空間上で飛び地ができるのを防ぐために広聴AIではこのような実装となっている
* プロンプトの違い
  * （アルゴリズムの違いに依存する話だが）広聴AIでは、第二階層のクラスタのタイトル・説明と、サンプリングしたクラスタに属するデータのテキストの情報に基づいて第一階層のタイトル・説明を生成している。一方でTTTCでは、下層のクラスタタイトル・説明を用いていない。
    * 下層のクラスタのタイトル・説明を包含するように指示しているため、抽象的なタイトルが生成されている可能性がある。


# 提案内容
プロンプトレベルでの修正と、アルゴリズムレベルでの修正がある。

## プロンプトレベルでの修正
1. デフォルトプロンプトの文言のチューニング・修正
2. プロンプトに入力する情報の修正
    例. 下層のタイトル・説明は含めずに、純粋にデータ点の情報だけ入力して第一階層のタイトル・説明を生成する


## アルゴリズムレベルでの修正
1. 元の埋込を用いてクラスタリングする
2. k-means以外のアルゴリズム（spectral clustering, hdbscan）を採用する


**コメント:** なし

---

### [[FEATURE]クラスタ数が増えた場合に散布図上でクラスタラベルが被ってしまう](https://github.com/digitaldemocracy2030/kouchou-ai/issues/266)

**作成者:** nasuka  
**作成日:** 2025-04-08T14:20:10Z  
**内容:**

# 背景
* クラスタ数が増えた場合に散布図上でクラスタラベルが被ってしまう
  * 添付画像は40件で出力したケース。多くのクラスタラベルが被ってしまっている。
![Image](https://github.com/user-attachments/assets/c8e61e43-ef60-4054-91d0-4b8f3e6f4847)

* この問題により、現在は第一階層のクラスタ数を大きな数値に設定できない
  * 現在は上限を20としているが、TTTCの過去事例では30件を表示していたケースもあるため、上限をもう少し大きくしたい

# 提案内容
解決するアプローチは幾つかありそう。

## 対策方針（Claudeによる案）
1. ラベル表示の選択的制限

- 重要度ベースの選択：クラスタサイズなどに基づき重要なラベルのみ表示
- 最大表示数の制限：表示するラベル数に上限を設定（例: 最大15個）
- ユーザー選択型表示：選択されたクラスタのみラベル表示

2. ラベルの視覚的最適化

- フォントサイズの縮小：ラベルのフォントサイズを小さくして占有面積を減らす
- 可変フォントサイズ：クラスタの重要度に応じてフォントサイズを調整
- ラベル省略表示：長いラベルを省略形で表示（例: "長いラベル名" → "長いラ..."）

3. インタラクティブ手法

- 凡例コンポーネントの追加：画面端に凡例を設け、クラスタ一覧を表示
- ホバー/クリック表示：マウスホバーやクリック時のみラベルを表示
- ハイライト機能：選択クラスタを強調し他を半透明化

4. レイアウト最適化

- ラベル位置の調整：ラベル同士の衝突を検出し位置を最適化
- クラスタのグルーピング：近接するクラスタを階層的に表示

**コメント:** なし

---

### [(情報整理)OpenAIが使えないケースのケア](https://github.com/digitaldemocracy2030/kouchou-ai/issues/255)

**作成者:** nishio  
**作成日:** 2025-04-08T03:21:10Z  
**内容:**

# 背景

政党に売り込む上で「ChatGPTの政治利用NG」が障害になる可能性がある？→あるのでケアが必要

解決案
 - A: そもそもAzure OpenAI ServiceならOKなのでは説(=対処完了済み)
 - B: Geminiを叩けるように変える
   - B-1: 直接Geminiを叩く分岐を環境変数でやる
   - B-2: OpenRouter経由にすることでOpenAI API形式でGeminiを叩けるようにする
   - B-3: [LiteLLM Proxy](https://scrapbox.io/nishio/LiteLLM_Proxy) でやるマニュアルを作る


# 提案内容
<!-- 実装案やデザイン案があれば記入してください -->

**コメント:** なし

---

### [(情報整理)Windows環境で試す人のためのガイドが必要](https://github.com/digitaldemocracy2030/kouchou-ai/issues/254)

**作成者:** nishio  
**作成日:** 2025-04-08T03:14:53Z  
**内容:**

Windows環境で試す人の踏みそうなトラブルシューティング

西尾も角野さんもMacなのでどんなトラブルが起きるのかを観測できてない感、issueでもslackでもガンガン書いてもらえるといいと思う

Windows環境で試すとなった時に、まずいきなり「生環境でやる」「WSLでやる」「Dockerでやる」の3つの選択肢があると思ってて、どれが一番スムーズなのかはよくわかってない、Windows環境のある人の協力があるとありがたいゾーン

関連Slack: https://w1740803485-clv347541.slack.com/archives/C08F7JZPD63/p1744081553571589

**コメント:** なし

---

### [[FEATURE] frontからstaticなHTMLファイルをexportしてDownloadできるようにする](https://github.com/digitaldemocracy2030/kouchou-ai/issues/220)

**作成者:** takahiroanno  
**作成日:** 2025-04-02T11:43:27Z  
**内容:**

# 背景
* static exportが実装されたが、現在はCLIで実行することしかできず、Webアプリ上で実行できない
  * `make client-build-static` を実行するとCLIではstatic exportができる
  * 参考
    * https://github.com/digitaldemocracy2030/kouchou-ai/pull/198
    * https://github.com/digitaldemocracy2030/kouchou-ai/pull/195


# 提案内容
* adminの一覧画面で、static exportを実行できるようにする

**コメント:** なし

---

### [[FEATURE]ファクトチェック機能の実装](https://github.com/digitaldemocracy2030/kouchou-ai/issues/170)

**作成者:** nasuka  
**作成日:** 2025-03-25T06:18:39Z  
**内容:**

# 背景
* 入力ファイル内のコメントが虚偽の場合がある
  * e.g. 「◯◯という人物が✗✗という発言をしていたが大変嘆かわしい」というコメントがあったとして、現状ではこのコメントの真偽に関わらずコメントが分析結果に組み込まれてしまう

# 提案内容
* 個別のコメント（or 意見）についてファクトチェックを行う
* クラスタリングやクラスタ説明文の生成時にファクトチェックの結果を組み込み
  * 組み込む方法はいくつかパターンがありそう
    * 1. 虚偽と判定されたargumentはクラスタ生成以降のプロセスで除外する
    * 2. クラスタタイトルや説明文生成時に、argumentのテキストだけでなくファクトチェックの結果（真偽）も入力して生成を行う
    * 3. 散布図上でargumentをホバー表示する際に、虚偽の疑いがあるargumentはそのことが分かるように表示を変える
  * ↑は一例だが、実現方針の具体化からassigneeの方にやっていただけるとありがたい

# 進め方
* いきなり機能を実装するのではなく、プロダクトとは独立してスクリプトを実装し、検証用のデータセットを使って結果の妥当性を評価する
  * 問題なければプロダクトの機能として実装を進める
  * 一旦実験系のIssueだけ立てておき、実験結果より自動評価が機能することがわかった段階でプロダクトへの実装イシューを立てる



**コメント:** なし

---

### [[FEATURE]LLMによるクラスタ品質の自動評価（実験）](https://github.com/digitaldemocracy2030/kouchou-ai/issues/144)

**作成者:** nasuka  
**作成日:** 2025-03-25T03:36:54Z  
**内容:**

# 背景
https://github.com/digitaldemocracy2030/kouchou-ai/issues/143

* こちらのイシューは上記のサブイシュー


# 提案内容
* LLMによるクラスタ品質の自動評価の実験を行う
  * 出力されたクラスタタイトル・説明文・所属データ点の情報に基づいて、LLMでクラスタの品質を評価する
* どのようなアプローチで評価するかは、assigneeの方におまかせする
  * 例としては、例えば以下のような評価項目のスコアをLLMで出力するようなアプローチがある
    * クラスタ内部の一貫性評価
      * クラスタタイトル・説明文・所属データのテキストを入力し、一貫性を100点満点でスコアリングする
    * クラスタ外部との分離度の評価
      * クラスタAの情報（タイトルや所属データ等）と、重心の距離が最もAに近いクラスタBの情報をLLMに入力し、分離度を出力する


**コメント:** なし

---

### [[REFACTOR] 濃いクラスタのアイコン変更](https://github.com/digitaldemocracy2030/kouchou-ai/issues/113)

**作成者:** nishio  
**作成日:** 2025-03-20T12:20:30Z  
**内容:**

# 現在の問題点

<img width="249" alt="Image" src="https://github.com/user-attachments/assets/bc626d04-e7c0-4245-9b01-e762d433a434" />

濃いクラスタのアイコンは特に意味はなくこれになっている


# 提案内容

多分叩き台の案がないとどう変えたらいいかの議論もできないと思うので雑に描いておく

![Image](https://github.com/user-attachments/assets/9e46dfd6-71d4-4c2b-bbd5-1c79220c8d80)

アイコンとしてデザインできるかは度外視して描くとこんな感じで「全体像」は全体にたくさんの点が散らばっており、「濃いクラスタ」はぎゅっとした「濃い」「密度の高い」塊がいくつかある感じ

**コメント:** なし

---

### [[FEATURE]CSVアップロード時にそれを処理した場合のコストを表示](https://github.com/digitaldemocracy2030/kouchou-ai/issues/79)

**作成者:** nishio  
**作成日:** 2025-03-18T03:19:29Z  
**内容:**

# 背景

>安野貴博: ファイルアップロードすると解析掛ける前にコストを教えてくれるの良さそうですね
>ほづみゆうき: ついにレポート出力まで漕ぎ着けたのですがAPI料金がどれくらいになるのかまったく感覚的に分からずドキドキだったので素人にはあると嬉しいと思います！

# 提案内容

これを実現するためには2つの要素が必要

- 1: done( ~~いまCSVアップロード即処理開始になっているが、一旦確認ダイアログを挟む必要がある~~ )
- 2: どのくらいのデータだとどれくらいの費用になるのかの見積もり関数が必要

## (2)の真面目な作り方

(1)は @nanocloudx さんが詳しいと思うが、(2)の部分がわからなくて着手できないと思う。
UI改善に着手する前に、この関数を作るためのデータ自体を集めていないのでそこからやる必要がある。

- a: extraction
- b: embedding
- c: その後のレポート作成

(a)がO(N)でgpt4oなので大きく、(b)はO(N)だがembedding modelなので安く、cはクラスタ数のオーダー(階層モデルなど今回いろいろ追加したから読めない)という感じで、このそれぞれに分けて料金を出せるようにしてデータ量違いでデータを集めればよい。

## (2)の雑な作り方

ユーザのペインは「すごい高額だったらどうしよう」だと思うので、まず「100円未満っすね」「100~1000円くらい」「これはでかいから1000円以上かかるよ」の3段階でいいのでは説

**コメント:** なし

---

### [[FEATURE] ISRによる表示遅延の案内表示](https://github.com/digitaldemocracy2030/kouchou-ai/issues/61)

**作成者:** nanocloudx  
**作成日:** 2025-03-16T08:08:04Z  
**内容:**

# 背景
新しいレポートが生成されてから、閲覧可能になるまでの間には約５分のラグがある
これは client で ISR を行っており、この頻度を 300sec にしているのが原因（この仕組み自体は問題ない認識）
この仕組みを知らないとレポート作成者が迷ってしまうので、５分遅れる旨を client-admin に書くとよさそう

Reference
https://nextjs.org/docs/app/building-your-application/data-fetching/incremental-static-regeneration

# 提案内容
client-admin にレポート生成完了から５分ぐらいは表示できないことがわかる文言を追加する


**コメント:** なし

---

### [[FEATURE] チャート表示に連動した文章表示](https://github.com/digitaldemocracy2030/kouchou-ai/issues/52)

**作成者:** nanocloudx  
**作成日:** 2025-03-16T03:43:03Z  
**内容:**

# 背景
レポートはチャートとクラスター文章から成っている
現在はチャート表示を切り替えたりしても、クラスター文章は初期表示のままである

# 提案内容
表示範囲の更新に合わせて、チャート下部にあるクラスター内容文章(cluster.takeaway)も更新する

**コメント:** なし

---

### [[FEATURE]レポートの複製・再利用機能](https://github.com/digitaldemocracy2030/kouchou-ai/issues/19)

**作成者:** nasuka  
**作成日:** 2025-03-04T11:38:39Z  
**内容:**

# 背景
* 設定を少しだけ変えて実行したいケースがある
  * 例えばクラスタ数だけ変えるなど


# 提案内容
* レポートの設定複製機能を実装する


# 機能の提供価値
* LLM APIコストの削減
  * レポート出力までのステップを途中から実行できるようになるためAPIのコストを削減できる
* レポート出力の高速化

**コメント:** なし

---

## Pull Requests

### 過去7日間にマージされたPR (17件)

### [[FEATURE] 意見グループのカラーバリエーションを20から40に増やす](https://github.com/digitaldemocracy2030/kouchou-ai/pull/332)

**作成者:** devin-ai-integration[bot]  
**作成日:** 2025-04-18T06:11:11Z  
**変更:** +20 -0 (1ファイル)  
**マージ日:** 2025-04-18T06:25:46Z  
**内容:**

# 概要
Issue #330 の対応として、意見グループのカラーバリエーションを20から40に増やしました。

## 変更内容
- `client/components/charts/ScatterChart.tsx` の `softColors` 配列に20色を追加
- 既存の色合いと被らないように新しい色を選定

## 関連Issue
Closes #330

## Link to Devin run
https://app.devin.ai/sessions/13cf7d9312e1499bbeda7a28e54f55af
Requested by: nsk.smn@gmail.com


**コメント:** なし

---

### [CSVダウンロード機能に用いるcsvを、Azure Blob Storage連携時の削除対象から除外](https://github.com/digitaldemocracy2030/kouchou-ai/pull/326)

**作成者:** nasuka  
**作成日:** 2025-04-17T16:33:35Z  
**変更:** +9 -8 (2ファイル)  
**マージ日:** 2025-04-17T17:00:05Z  
**内容:**

# 変更の概要
* CSVダウンロード機能に用いるcsv( `final_result_with_comments.csv` )を、Azure Blob Storage連携時の削除対象から除外
  * 従来は誤って削除対象になっていた
* アプリ起動時の同期対象に同ファイルを含めるよう修正

# 変更の背景
ストレージ連携をしている場合は、ストレージに出力ファイル等をアップロードをした後に容量節約のために不要なファイルを削除しているが、その際に当該のCSVファイルも削除されてしまっているためDLできなくなっていた。
当該ファイルはAzure Blob Storage上には保存されているが、アプリ起動時の同期対象からも外れておりアプリ上には存在しないため、アプリの再起動やコンテナの更新を行った場合もDLできなくなっていた。
ストレージにはcsvは保管されているので、今回の修正を反映した上でアプリ（コンテナ）を再起動すれば、以降はCSVをDLできるようになる。


# 関連Issue
Close https://github.com/digitaldemocracy2030/kouchou-ai/issues/325

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [レポート作成時にISR関連の注意書きを追加する](https://github.com/digitaldemocracy2030/kouchou-ai/pull/322)

**作成者:** mtane0412  
**作成日:** 2025-04-17T11:30:55Z  
**変更:** +106 -0 (2ファイル)  
**マージ日:** 2025-04-17T14:37:44Z  
**内容:**

# 変更の概要
以下の注意書きをAlertコンポーネントでレポート作成ボタンの上に追加 ([@nasuka案](https://github.com/digitaldemocracy2030/kouchou-ai/issues/61#issuecomment-2795883061)) 
- レポートの作成には数分から数十分程度の時間がかかります
- 作成が完了したレポートが一覧画面に反映されるまで5分程度かかります

![](https://i.gyazo.com/334fa5543cea24e5512c14b4d941d02a.png)

# 変更の背景
> 新しいレポートが生成されてから、閲覧可能になるまでの間には約５分のラグがある
> これは client で ISR を行っており、この頻度を 300sec にしているのが原因（この仕組み自体は問題ない認識）
> この仕組みを知らないとレポート作成者が迷ってしまうので、５分遅れる旨を client-admin に書くとよさそう

# 関連Issue
#61 

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [CSVダウンロードにBOM付きオプションを追加する](https://github.com/digitaldemocracy2030/kouchou-ai/pull/321)

**作成者:** mtane0412  
**作成日:** 2025-04-17T10:21:24Z  
**変更:** +110 -42 (1ファイル)  
**マージ日:** 2025-04-17T16:09:46Z  
**内容:**

# 変更の概要
- CSVダウンロードボタンを押してCSVをダウンロードするのを、Popoverを表示して通常CSVとUTF-8 BOM (Byte Order Mark) 付きのCSVを選んでダウンロードできるようにした
- 通常のCSVは「CSV」で、BOM付きは「CSV for Excel (Windows)」とした
- UTF-8 BoM付きCSVは `original-name_excel.csv` のような形式でダウンロードする

![](https://i.gyazo.com/c900123a1fdd45ee8ced48243eba6aa4.png)

# 変更の背景
- WindowsユーザーがExcelを開くとBOM付きでないCSVは文字化けする問題がある
- 「UTF-8 BOM」という表記は非技術者に伝わりづらいため、CSV for Excel (Windows)と表現した。

# 関連Issue
#297

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [レポート作成日時にtimezoneをつけて保存](https://github.com/digitaldemocracy2030/kouchou-ai/pull/320)

**作成者:** nasuka  
**作成日:** 2025-04-17T05:05:34Z  
**変更:** +2 -2 (1ファイル)  
**マージ日:** 2025-04-17T16:58:40Z  
**内容:**

# 変更の概要
- レポート作成日時対してtimezone（UTC）つきで保存するように変更
  - これにより、レポートの一覧画面でJSTで作成日時が表示されるようになる（従来はUTCだった）
# 変更の背景
- 従来の保存形式ではtimezoneの情報が付加されていなかった
  - フロント側ではJSTに変換して日時を表示するようになっているが、保存されている元データにtimezoneの情報がないためUTCのまま表示されていた
    - 今回の実装のスコープにはしていないが、本来的にはJST固定ではなく閲覧しているブラウザの環境情報等からtimezoneを読み取った上で時刻表示するのが望ましい（現状日本以外ではそこまで使われないと思われるので対応していない）


注意点として、以前のバージョンで出力したレポートについては引き続きUTCのまま時刻が表示される。
（timezoneなしの作成日時が保存されている場合にtimezoneつきに変換する処理を入れれば対応可能ではあるが、実装が若干増えるのに対してインパクトが見合わないように思ったので対応していない）

# 関連Issue
Close https://github.com/digitaldemocracy2030/kouchou-ai/issues/317

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [ラベリングのデフォルトプロンプトをアップデート](https://github.com/digitaldemocracy2030/kouchou-ai/pull/319)

**作成者:** nasuka  
**作成日:** 2025-04-17T04:41:43Z  
**変更:** +25 -17 (2ファイル)  
**マージ日:** 2025-04-17T08:06:05Z  
**内容:**

# 変更の概要
* 初期ラベリング・統合ラベリングのプロンプトをアップデート
  * 従来のプロンプトは抽象的なタイトルがつけられがちだったので、より具体性のあるタイトルをつけるようにプロンプトをアップデート

新プロンプト・旧プロンプトの結果比較はこちら
https://docs.google.com/spreadsheets/d/1xjZ48M-haKk1y6znsuMeverotwAw-kBJjTtCcQ0qpP8/edit?gid=1478680723#gid=1478680723

# 変更の背景
* 広聴AIで出力した第一階層のクラスタタイトルが、TTTCのタイトルと比べて具体性に欠ているという声があった

# 関連Issue
https://github.com/digitaldemocracy2030/kouchou-ai/issues/269

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [レポート一覧のクリック可能範囲を広げる(#207)](https://github.com/digitaldemocracy2030/kouchou-ai/pull/316)

**作成者:** mtane0412  
**作成日:** 2025-04-16T15:11:44Z  
**変更:** +56 -13 (1ファイル)  
**マージ日:** 2025-04-16T16:34:54Z  
**内容:**

# 変更の概要
- レポート一覧画面で各カードにマウスオーバーするとカードがグレーになり、中央に「レポートを表示」というボックスが表示される
- カード全体(既存のボタンを除く)をクリックするとレポートが開く
- 既存のレポートページへ飛ぶアイコンは削除

![](https://i.gyazo.com/f4b591f63332a0d3bc21741c95e6b581.jpg)

# 変更の背景
- 初見のユーザーがどこをクリックしていいか分からない問題があった
- マウスオーバー効果でクリッカブルであることが分からない層にも伝わるように「レポートを表示」を出すようにした
- 既存のレポート表示ボタンは重複するので削除した

# 関連Issue
#207 

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [改行コード混在の解消のため .gitattributes を追加（#243 対応）](https://github.com/digitaldemocracy2030/kouchou-ai/pull/314)

**作成者:** take365  
**作成日:** 2025-04-16T03:07:22Z  
**変更:** +2 -0 (1ファイル)  
**マージ日:** 2025-04-16T04:17:35Z  
**内容:**

# 変更の概要

- `.gitattributes` を追加し、改行コード（LF / CRLF）をファイル種別ごとに明示的に制御するようにしました。

# 変更の背景

- Windows環境での利用時、Git の自動変換（`core.autocrlf`）やエディタの設定により `.sh` ファイルが CRLF になってしまい、
  POSIXシェルで構文エラー（"unexpected 'fi' (expecting 'then')"）が発生するケースがありました。
- これは entrypoint.sh の構文の問題ではなく、改行コードが Windows形式（CRLF）で保存されたことが原因です。
- `.gitattributes` によって `*.sh` は LF、`*.bat` や `*.cmd` は CRLF に固定することで、OS間の不整合を防ぎます。

# 関連Issue

- https://github.com/digitaldemocracy2030/kouchou-ai/issues/243
- https://github.com/digitaldemocracy2030/kouchou-ai/issues/286
# CLAへの同意

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [Windowsユーザの利用環境構築 #300　の調整](https://github.com/digitaldemocracy2030/kouchou-ai/pull/313)

**作成者:** take365  
**作成日:** 2025-04-16T02:49:17Z  
**変更:** +50 -20 (4ファイル)  
**マージ日:** 2025-04-16T04:17:06Z  
**内容:**

# 変更の概要
setup_win.bat の文言を英語化し、Docker起動時の挙動を --build に変更
起動・停止用の補助バッチファイル（start_win.bat, stop_win.bat）を追加
運用手順を含めたガイド（windows-setup.md）を追記

# 変更の背景
リンクが切れている部分があった(sample.envとずれていた）
日本語の影響で処理が異常になった。かといってSJISにするとwebで化ける
docker compose up -d では.env の変更が反映されないことがあるため、初回実行時から --build を使うように変更
コマンド操作が苦手な非エンジニアの利用者向けに、クリックだけで起動・停止できるバッチファイルを用意
その利用手順を windows-setup.md に明記し、運用しやすい形にしました

# 関連Issue
https://github.com/digitaldemocracy2030/kouchou-ai/issues/300


- [x ] CLAの内容を読み、同意しました

**コメント:** なし

---

### [濃いクラスタ抽出で対象となるクラスタがない時にはボタンをdisabledにする](https://github.com/digitaldemocracy2030/kouchou-ai/pull/312)

**作成者:** nishio  
**作成日:** 2025-04-15T09:31:15Z  
**変更:** +103 -26 (3ファイル)  
**マージ日:** 2025-04-15T09:51:35Z  
**内容:**

# 変更の背景+概要

https://w1740803485-clv347541.slack.com/archives/C08F7JZPD63/p1743685246693499
>少ないデータに「濃い意見グループ」分析をかけた時に何が起こるか
>- getDenseClusters関数が末端グループを対象に濃度でのフィルタリングをする。この時「最小クラスタサイズ」の制約があるのでみんな小さすぎる時はフィルター結果が空になる。このフィルターは末端グループだけフィルターし、親グループはそのまま残す仕組みになっている。
>- フィルターされた結果を受け取ったChartコンポーネントは、チャートの種類選択が「濃い意見グループ」の時、データから一番深いグループを計算してそのレベルのグループを表示する。このとき「本来の末端グループがすべてフィルターされてる」ことで、上位のグループが表示されてしまう
>- 修正案: getDenseClustersが「フィルター結果がemptyか」のbooleanをセットで返すようにし、emptyな時には「濃い意見グループ」のボタンをdisabledにする

# 関連Issue
- #96

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [レビュアー向けのガイドラインを追記](https://github.com/digitaldemocracy2030/kouchou-ai/pull/311)

**作成者:** nasuka  
**作成日:** 2025-04-15T09:25:07Z  
**変更:** +16 -0 (2ファイル)  
**マージ日:** 2025-04-15T09:47:10Z  
**内容:**

# 変更の概要
レビュアー向けのガイドラインを追記し、DevinのPRに関する取り扱いルールを記載


# 変更の背景
DevinのPRについて、レビュアー側がどのようなアクションを起こすべきかわからず戸惑う場面があった

引用
```
DevinによるPR、作成中で裏で人間と議論してるのか、一旦終わって他人のレビューを待ってるのか区別つかないのでトリガー引いた人がコメントしてからレビューするとかなんかいい感じの運用方針が必要な気がする
```

# 関連Issue
関連するIssueのリンクをこちらに記載してください

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [Update windows-setup.md](https://github.com/digitaldemocracy2030/kouchou-ai/pull/307)

**作成者:** nishio  
**作成日:** 2025-04-13T13:51:57Z  
**変更:** +5 -4 (1ファイル)  
**マージ日:** 2025-04-13T13:52:08Z  
**内容:**

軽微なドキュメントの更新

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [Windows環境でのセットアップ簡素化 (Issue #300)](https://github.com/digitaldemocracy2030/kouchou-ai/pull/301)

**作成者:** nishio  
**作成日:** 2025-04-13T04:02:24Z  
**変更:** +98 -0 (2ファイル)  
**マージ日:** 2025-04-13T10:01:59Z  
**内容:**

## 概要

このPRはIssue #300に対応し、Windows環境でのkouchou-aiのセットアップを簡素化するための実装を提供します。

## 実装内容

1. `setup_win.bat` - Windowsユーザー向けセットアップスクリプト
   - Docker Desktopの起動確認
   - OpenAI APIキーの入力プロンプト
   - 環境変数の自動設定
   - docker composeによるサービス起動

2. `docs/windows-setup.md` - Windows環境でのセットアップ手順ドキュメント
   - 前提条件の説明
   - Docker Desktopのインストール手順
   - リポジトリのダウンロード方法
   - OpenAI APIキーの取得方法
   - セットアップの実行手順
   - トラブルシューティング

## ユーザーストーリー

このPRにより、以下のユーザーストーリーが実現されます：
- Docker Desktopをインストール
- zipでrepoをダウンロード
- OpenAI APIキーを取得してくらいチャージする
- setup_win.batを実行
- ブラウザでアクセス可能になる

## この後の流れ

これをマージした後で、Windowsユーザに`docs/windows-setup.md`の手順でセットアップができるか試してもらう

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [docker-compose → docker compose](https://github.com/digitaldemocracy2030/kouchou-ai/pull/299)

**作成者:** nishio  
**作成日:** 2025-04-13T01:43:23Z  
**変更:** +3 -3 (1ファイル)  
**マージ日:** 2025-04-13T02:57:04Z  
**内容:**

# 変更の概要
- ここに変更の概要を記載してください

# 変更の背景
- ここに変更が必要となった背景を記載してください

# 関連Issue
https://github.com/digitaldemocracy2030/kouchou-ai/issues/298

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [fix issue #278 : 要約文が「全画面終了」ボタンの後ろに隠れないようにする](https://github.com/digitaldemocracy2030/kouchou-ai/pull/282)

**作成者:** masatosasano2  
**作成日:** 2025-04-11T20:22:05Z  
**変更:** +51 -3 (3ファイル)  
**マージ日:** 2025-04-15T02:11:36Z  
**内容:**

# 変更の背景
全画面表示の「全画面終了」ボタンの後ろに要素の要約文が一部隠れてしまい、読めないことがある。

# 関連Issue
https://github.com/digitaldemocracy2030/kouchou-ai/issues/278

# 変更の概要
- `client/components/charts/ScatterChart.tsx` と`client/components/charts/TreemapChart.tsx` の props に `onHover` 用のfunctionを追加。 `onHover` が有効であることは以下で確認： https://github.com/plotly/react-plotly.js/blob/master/src/factory.js
- `client/components/report/Chart.tsx` に `onHover` 用のfunctionを実装。内容は「全画面終了ボタンと要約文の吹き出しが重なる場合に重ならなくなる位置まで吹き出しを下方向にずらす」。

# 動作確認結果
○
- 全画面表示でない場合は挙動が変わらない
- 要約文がボタンに隠れない場合は挙動が変わらない
- 要約文がボタンに隠れる場合は、一番右上の要素でなくとも被らなくなるまで要約文が下方向にずれる
- 下方向にずれた場合、要約文の背景が吹き出し型であれば吹き出しの先端だけ元の位置に紐づく

△
- `ScatterChart` の場合、マウス移動のたびに `onHover` と `onUnhover` が交互に発火されるのだが、 `onHover` のたびに要約文が再描画され、本修正の位置ずらしがリセットされてしまう。そのため、 `ScatterChart` ではsetTimeoutで位置ずらしを実行するタイミングを遅らせている。これにより概ね意図通り動作するようになったが、マウスの動かし具合によっては戻ってしまうこともある。ReactのイベントとしてはonMouseMoveなどほしいものが発火されていないので、これ以上精度を上げるには独自にmousemoveイベントなどを作成する必要があるが、効果の割に影響範囲調査含めて実装コストが高そうなので、Issue [#283](https://github.com/digitaldemocracy2030/kouchou-ai/issues/283) に分離する。

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [エラーで落ちても進捗状況を自動更新する](https://github.com/digitaldemocracy2030/kouchou-ai/pull/279)

**作成者:** 101ta28  
**作成日:** 2025-04-11T07:26:14Z  
**変更:** +141 -34 (2ファイル)  
**マージ日:** 2025-04-11T11:30:40Z  
**内容:**

close #277 

# 変更の概要
- server/serc/routers/admin_report.py
  - ステータスの追加・修正
-  client-admin/app/page.tsx
  - useReportProgressPollの修正
  - ReportCardの修正
  - リロードなしで画面更新するようにしました

## 添付画像

エラーが発生した場合

![error](https://github.com/user-attachments/assets/46c419b4-b8d7-4c70-b7e6-25408f0504f9)

処理が成功した場合

![success](https://github.com/user-attachments/assets/104445f1-58b3-409a-ba7a-e53d657bb4fd)

# 変更の背景
> 正常に動作するとstep1(抽出)からstep8(可視化)まで自動更新され、その後レポートのURLが表示されるが、
> エラーで落ちると進捗が更新されず、ページを再読込して初めてエラーになったことが可視化される。

# 関連Issue
#277 

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [Azureの更新のためのターゲットを追加](https://github.com/digitaldemocracy2030/kouchou-ai/pull/215)

**作成者:** nishio  
**作成日:** 2025-04-01T08:25:51Z  
**変更:** +67 -18 (1ファイル)  
**マージ日:** 2025-04-17T14:50:50Z  
**内容:**

# 変更の背景
https://github.com/digitaldemocracy2030/kouchou-ai/issues/214

# 変更の概要
- Azureの更新のためのターゲットを追加


# 関連Issue
https://github.com/digitaldemocracy2030/kouchou-ai/issues/214


# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### 過去7日間に作成されたPR (3件)

### [OpenAI API Rate Limit対策の実装](https://github.com/digitaldemocracy2030/kouchou-ai/pull/331)

**作成者:** devin-ai-integration[bot]  
**作成日:** 2025-04-18T06:00:08Z  
**変更:** +62 -31 (1ファイル)  
**内容:**

# OpenAI API Rate Limit対策の実装

## 概要
Issue #295 に記載されている問題を解決するため、OpenAI APIのRate Limit (429) エラーに対して指数バックオフ付きリトライ処理を実装しました。

## 変更内容
- tenacityライブラリを使用して、OpenAI APIのRate Limit (429) エラーに対する指数バックオフ付きリトライ処理を実装
- `request_to_openai`と`request_to_azure_chatcompletion`関数に対してリトライデコレータを追加
- エラー発生時のログ出力を追加
- リトライ設定：
  - 最大3回のリトライ
  - 指数バックオフ（初期2秒、最大60秒）
  - RateLimitErrorとAPIStatusErrorに対してリトライ

## テスト
- 実装後の動作確認を行いました

Link to Devin run: https://app.devin.ai/sessions/67c2a06784d74e068af3a03c787f2394
Requested by: nsk.smn@gmail.com


**コメント:** なし

---

### [意見グループのタイトルの表示/非表示を設定する項目を実装](https://github.com/digitaldemocracy2030/kouchou-ai/pull/329)

**作成者:** nasuka  
**作成日:** 2025-04-18T05:38:30Z  
**変更:** +92 -22 (6ファイル)  
**内容:**

# 変更の概要
* 意見グループのタイトルの表示/非表示を設定する項目を実装
  * 元々あった「濃い意見グループ設定」のモーダルを「表示設定」に改名し、その中にトグルスイッチを配置している
* 表示がONの場合は全てのタイトルが表示され、OFFの場合はどのクラスタのタイトルも表示されない
  * ON/OFFの状態は全画面表示の際も引き継がれる


設定モーダル
![image](https://github.com/user-attachments/assets/474f7635-a3e3-4a26-94d0-004c3e6aec4d)


動作イメージ
![a3e20d4504a83d9a139a4953257cb8db](https://github.com/user-attachments/assets/a5c21b07-488b-4fa6-9046-3290901e1e15)



# 変更の背景
- 意見グループ数が増えるとラベルが重なって見にくくなるという問題がある
  - この問題があるため、意見グループを一定以上に増やすことが難しい

# 関連Issue
Close https://github.com/digitaldemocracy2030/kouchou-ai/issues/327

# CLAへの同意
- 本リポジトリへのコントリビュートには、[コントリビューターライセンス契約（CLA）](https://github.com/digitaldemocracy2030/kouchou-ai/blob/main/CLA.md)に同意することが必須です。
内容をお読みいただき、下記のチェックボックスにチェックをつける（"- [ ]" を "- [x]" に書き換える）ことで同意したものとみなします。

- [x] CLAの内容を読み、同意しました

**コメント:** なし

---

### [静的ファイルエクスポート機能の追加 (#220)](https://github.com/digitaldemocracy2030/kouchou-ai/pull/309)

**作成者:** devin-ai-integration[bot]  
**作成日:** 2025-04-15T05:29:02Z  
**変更:** +194 -10 (11ファイル)  
**内容:**

# 静的ファイルエクスポート機能の追加

Issue: #220

## 変更内容
- clientアプリに静的ファイル出力用APIエンドポイント（/api/static-export）を追加
- client-adminアプリの一覧画面に「全レポートをエクスポート」ボタンを追加
- ボタンクリック時にclientの/api/static-exportエンドポイントを呼び出し、静的ビルドを実行
- 生成されたZIPファイルをダウンロードする機能を実装

## テスト方法
- clientアプリの/api/static-exportエンドポイントにアクセスし、静的ビルドが実行されZIPファイルがダウンロードされることを確認
- client-adminアプリの一覧画面の「全レポートをエクスポート」ボタンをクリックし、静的ビルドが実行されZIPファイルがダウンロードされることを確認

Link to Devin run: https://app.devin.ai/sessions/c429bebcd84540059a6560b3dad3db7a


**コメント:** なし

---

### 過去7日間に更新されたPR（作成・マージを除く）(2件)

### [Fix #274: 静的ビルド時のhttp://localhostの参照を相対パスに修正](https://github.com/digitaldemocracy2030/kouchou-ai/pull/275)

**作成者:** devin-ai-integration[bot]  
**作成日:** 2025-04-10T07:00:47Z  
**変更:** +29 -17 (8ファイル)  
**内容:**

このPRでは、静的ビルド時に含まれる絶対URLパス（http://localhost）を相対パスに修正し、どこでも動作するようにします。

修正内容:
- getApiBaseUrl() 関数を修正して静的ビルド時に相対パスを返すよう変更
- エラーメッセージの中のURLパス参照を修正
- metadataBase の設定を静的ビルド時に適切に処理するよう修正
- GitHub Actions のビルド設定を修正

Link to Devin run: https://app.devin.ai/sessions/11ffaf2b93ea42538a5b43e27563b24c
Requested by: nsk.smn@gmail.com

**コメント:** なし

---

### [[FEATURE] Admin一覧画面からstatic exportを実行できるようにする](https://github.com/digitaldemocracy2030/kouchou-ai/pull/273)

**作成者:** devin-ai-integration[bot]  
**作成日:** 2025-04-10T03:16:15Z  
**変更:** +970 -27 (11ファイル)  
**内容:**

## 変更内容
- Admin一覧画面に「全レポートをエクスポート」ボタンを追加
- クライアントサイドにstatic exportを実行するAPIエンドポイントを追加
- エクスポート結果をZIPファイルとしてダウンロードする機能を実装

issue #220 の対応

### テスト方法
1. Admin画面のレポート一覧で「全レポートをエクスポート」ボタンをクリック
2. エクスポート処理が完了するとZIPファイルがダウンロードされる
3. ZIPファイルを展開し、HTMLファイルが正しく含まれていることを確認

### 実装の詳細
- 本番環境ではDockerが利用できない可能性があるため、クライアントサイドでビルドを実行する方式に変更
- クライアントアプリに専用のAPIエンドポイント（/api/static-export）を追加し、npmスクリプトを実行
- 管理画面からはこのエンドポイントを呼び出してZIPファイルをダウンロード

Link to Devin run: https://app.devin.ai/sessions/99a83805083043dcb3b8a24f38fc766a
Requested by: nsk.smn@gmail.com

**コメント:** なし

---

